# /Users/valentinfokin/Desktop/CorePath OS 2.0/app.py
import streamlit as st
import json
from dataclasses import asdict
import base64
from datetime import date
from core_logic import (
    IngestionEngine, 
    BlueOceanEngine, 
    HarmonyDiagnosticEngine, 
    StrategyEngine,
    CommerceEngine, 
    ClientProfileHub,
    AIScenarioProducer, 
    InterviewEngine,
    CalendarEngine,
    ANCHOR_POINTS_DATA,
    InfluenceAsset,
    TeamMember,
    Comment,
    Attachment
)

# --- –ù–û–í–´–ô –ë–õ–û–ö: –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ–ø—Ä–æ—Å–Ω–∏–∫–∞ ---
# –ü–æ–ª–Ω—ã–π, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–ø—Ä–æ—Å–Ω–∏–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
QUESTIONNAIRE_QUESTIONS = {
    "–ë–ª–æ–∫ 0: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è": {
        "q0": "–§–ò–û –∏–ª–∏ –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏"
    },
    "–ë–ª–æ–∫ 1: –¢–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –°–ø—Ä–∏–Ω—Ç": {
        "q1": "1. –ï—Å–ª–∏ –±—ã —É –Ω–∞—Å –±—ã–ª–æ –≤—Å–µ–≥–æ 30 –¥–Ω–µ–π –Ω–∞ —Å–æ–≤–º–µ—Å—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É, –∫–∞–∫–æ–π –æ–¥–∏–Ω —Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–≤ –¥–µ–Ω—å–≥–∞—Ö, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è—Ö, –ø–æ–¥–ø–∏—Å—á–∏–∫–∞—Ö) —Å–Ω—è–ª –±—ã 80% —Ç–≤–æ–µ–≥–æ —Å—Ç—Ä–µ—Å—Å–∞?"
    },
    "–ë–ª–æ–∫ 2: –§–ê–ó–ê F (Foundation / BSC) ‚Äî –ß–∞—Å—Ç—å –ê: –õ–∏—á–Ω—ã–µ –¶–µ–ª–∏": {
        "q2": "1. –¢—Ä–∏ –∑–∞–≤–µ—Ç–Ω—ã–µ –º–µ—á—Ç—ã (–µ—Å–ª–∏ –æ—Ç–±—Ä–æ—Å–∏—Ç—å '—Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å')?",
        "q3": "2. –ß—Ç–æ —Ç—ã –∏—â–µ—à—å –≤ –ª—é–±–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏? (–ü—Ä–∏–∑–Ω–∞–Ω–∏–µ, –ª—é–±–æ–≤—å, –¥–µ–Ω—å–≥–∏, —Å–≤–æ–±–æ–¥–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å?)",
        "q4": "3. –û–ø–∏—à–∏ —Å–≤–æ–π '–∏–¥–µ–∞–ª—å–Ω—ã–π –¥–µ–Ω—å' —á–µ—Ä–µ–∑ 3 –≥–æ–¥–∞.",
        "q5": "4. –ö–∞–∫–∏–µ —É —Ç–µ–±—è –µ—Å—Ç—å '–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–∏–µ —É–±–µ–∂–¥–µ–Ω–∏—è' –æ –¥–µ–Ω—å–≥–∞—Ö, —É—Å–ø–µ—Ö–µ, –º–µ–¥–∏–π–Ω–æ—Å—Ç–∏?",
        "q6": "5. –ö–∞–∫–∏–µ —É —Ç–µ–±—è –µ—Å—Ç—å '–Ω–µ-–±–∏–∑–Ω–µ—Å' –Ω–∞–≤—ã–∫–∏? (–≠–º–ø–∞—Ç–∏—è, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞, —é–º–æ—Ä?)",
        "q7": "6. –ß—Ç–æ —Ç—ã –º–æ–∂–µ—à—å –¥–µ–ª–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ –∏ —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º?",
        "q8": "7. –ë–µ–∑ –∫–∞–∫–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Ç—ã –Ω–µ –≥–æ—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞—Ç—å? (–ß—Ç–æ —Ç–µ–±—è '–≤—ã–∂–∏–≥–∞–µ—Ç'?)",
        "q9": "8. –ö–∞–∫–∏–µ —É —Ç–µ–±—è '–≤—Ä–µ–¥–Ω—ã–µ' –ø—Ä–∏–≤—ã—á–∫–∏ –∏–ª–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –±–ª–æ–∫–∏—Ä—É—é—Ç —Ä–æ—Å—Ç?"
    },
    "–ë–ª–æ–∫ 2: –§–ê–ó–ê F (Foundation / BSC) ‚Äî –ß–∞—Å—Ç—å –ë: –ë–∏–∑–Ω–µ—Å-–¶–µ–ª–∏": {
        "q10": "1. –ö–∞–∫–∞—è —É —Ç–µ–±—è —Ç–µ–∫—É—â–∞—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤–∞—è –ª–∏–Ω–µ–π–∫–∞? (–ß—Ç–æ? –ü–æ –∫–∞–∫–æ–π —Ü–µ–Ω–µ?)",
        "q11": "2. –ö–∞–∫–æ–π —Ç–µ–∫—É—â–∏–π —Å—Ä–µ–¥–Ω–µ–º–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥? –ö–∞–∫–∞—è —Ü–µ–ª—å –Ω–∞ 1 –≥–æ–¥?",
        "q12": "3. –ö–∞–∫ —Å–µ–π—á–∞—Å –≤—ã–≥–ª—è–¥–∏—Ç —Ç–≤–æ—è –≤–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂? (–û—Ç–∫—É–¥–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –ª—é–¥–∏ –∏ –∫–∞–∫ –æ–Ω–∏ –ø–æ–∫—É–ø–∞—é—Ç?)",
        "q13": "4. –ö–∞–∫–∞—è —É —Ç–µ–±—è –±–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å (–æ–Ω–ª–∞–π–Ω-—à–∫–æ–ª–∞, —É—Å–ª—É–≥–∏, –ø—Ä–æ–¥. —Ü–µ–Ω—Ç—Ä)?",
        "q14": "5. –ö–∞–∫–∏–µ —É —Ç–µ–±—è –∫–ª—é—á–µ–≤—ã–µ –∞–∫—Ç–∏–≤—ã? (–ö–æ–º–∞–Ω–¥–∞, –±–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è, –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è?)"
    },
    "–ë–ª–æ–∫ 2: –§–ê–ó–ê F (Foundation / BSC) ‚Äî –ß–∞—Å—Ç—å –í: –û–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ / –ú–∏—Å—Å–∏—è": {
        "q15": "1. –ö–∞–∫—É—é '–Ω–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å' –∏–ª–∏ '–ø—Ä–æ–±–ª–µ–º—É' –≤ –º–∏—Ä–µ —Ç—ã —Ö–æ—á–µ—à—å —Ä–µ—à–∏—Ç—å?",
        "q16": "2. –ï—Å–ª–∏ —Ç—ã —Ä–µ—à–∏—à—å —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É, –∫–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—Å—è –º–∏—Ä/–∏–Ω–¥—É—Å—Ç—Ä–∏—è?"
    },
    "–ë–ª–æ–∫ 2: –§–ê–ó–ê F (Foundation / BSC) ‚Äî –ß–∞—Å—Ç—å –ì: –ú–µ–¥–∏–π–Ω—ã–µ": {
        "q17": "1. –ß—Ç–æ –¥–ª—è —Ç–µ–±—è '—É—Å–ø–µ—Ö' –≤ –º–µ–¥–∏–∞? (–¶–∏—Ñ—Ä—ã, —Å—Ç–∞—Ç—É—Å, –≤–ª–∏—è–Ω–∏–µ?)",
        "q18": "2. –ß–µ–π —É—Ä–æ–≤–µ–Ω—å –º–µ–¥–∏–π–Ω–æ—Å—Ç–∏ –¥–ª—è —Ç–µ–±—è ‚Äî —ç—Ç–∞–ª–æ–Ω?"
    },
    "–ë–ª–æ–∫ 3: –§–ê–ó–ê F (Foundation / Blue Ocean) ‚Äî '–û—Ç–º–µ–Ω–∞ –ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏'": {
        "q19": "1. –ù–∞–∑–æ–≤–∏ 3-5 –≥–ª–∞–≤–Ω—ã—Ö '–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤' –∏–ª–∏ '–ª–∏–¥–µ—Ä–æ–≤' –≤ —Ç–≤–æ–µ–π –Ω–∏—à–µ.",
        "q20": "2. –ß—Ç–æ –≤—Å–µ –æ–Ω–∏ –¥–µ–ª–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ? –ö–∞–∫–æ–π '—Å—Ç–∞–Ω–¥–∞—Ä—Ç –∏–Ω–¥—É—Å—Ç—Ä–∏–∏' —Ç—ã —Å—á–∏—Ç–∞–µ—à—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º –∏–ª–∏ –≥–ª—É–ø—ã–º?",
        "q21": "3. –ß—Ç–æ –æ–Ω–∏ –¥–µ–ª–∞—é—Ç '—Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ', –Ω–∞ —á—Ç–æ —Ç—Ä–∞—Ç—è—Ç —Ä–µ—Å—É—Ä—Å—ã, –∞ –∫–ª–∏–µ–Ω—Ç—É —ç—Ç–æ –Ω–µ –Ω—É–∂–Ω–æ?",
        "q22": "4. –ß—Ç–æ –æ–Ω–∏ –Ω–µ –¥–µ–ª–∞—é—Ç, –Ω–æ —Ç—ã —Å—á–∏—Ç–∞–µ—à—å —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–º?",
        "q23": "5. –ß—Ç–æ –≤ —Ç–≤–æ–µ–π –Ω–∏—à–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–µ–ª–∞–ª–∏, –Ω–æ —ç—Ç–æ –º–æ–≥–ª–æ –±—ã '–≤–∑–æ—Ä–≤–∞—Ç—å' —Ä—ã–Ω–æ–∫?"
    },
    "–ë–ª–æ–∫ 4: –§–ê–ó–ê O (Orchestration / Ecosystem) ‚Äî '–ö–∞—Ä—Ç–∞ –°—Ç–µ–π–∫—Ö–æ–ª–¥–µ—Ä–æ–≤'": {
        "q24": "1. –û–ø–∏—à–∏ —Å–≤–æ–µ–≥–æ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ (–∫—Ç–æ —É–∂–µ —Ç–µ–±—è —Å–º–æ—Ç—Ä–∏—Ç, –∫–∞–∫–∏–µ —É –Ω–µ–≥–æ –±–æ–ª–∏).",
        "q25": "2. –û–ø–∏—à–∏ —Å–≤–æ–µ–≥–æ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –ø–ª–∞—Ç–∏–ª —Ç–µ–±–µ (–ø–æ—á–µ–º—É –æ–Ω –∫—É–ø–∏–ª, –∫–∞–∫—É—é —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É —Ä–µ—à–∏–ª).",
        "q26": "3. –ù–∞–∑–æ–≤–∏ 3-5 '–≥–µ–π—Ç–∫–∏–ø–µ—Ä–æ–≤' ‚Äî –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∏–≥—É—Ä –≤ —Ç–≤–æ–µ–π –Ω–∏—à–µ, —á—å–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∏–ª–∏ –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏—è –¥–∞–¥—É—Ç —Ç–µ–±–µ —Ä–µ–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç.",
        "q27": "4. –ö–∞–∫–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏, –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, –±—Ä–µ–Ω–¥—ã, —Ñ–µ—Å—Ç–∏–≤–∞–ª–∏ –∏–ª–∏ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã –≤ —Ç–≤–æ–µ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–µ?",
        "q28": "5. –ï—Å–ª–∏ –±—ã —Ç—ã –º–æ–≥ –¥–æ—Ç—è–Ω—É—Ç—å—Å—è –¥–æ –æ–¥–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ (–ø–æ–ª–∏—Ç–∏–∫–∞, –æ–ª–∏–≥–∞—Ä—Ö–∞, —Ç–æ–ø-–º–µ–Ω–µ–¥–∂–µ—Ä–∞), –∫–æ—Ç–æ—Ä—ã–π –∏–∑–º–µ–Ω–∏–ª –±—ã –≤—Å—ë, –∫—Ç–æ –±—ã —ç—Ç–æ –±—ã–ª?"
    }
}


# ==============================================================================
# --- –ë–õ–û–ö 3: –ò–ù–¢–ï–†–§–ï–ô–° STREAMLIT –ò –õ–û–ì–ò–ö–ê –ó–ê–ü–£–°–ö–ê ---
# ==============================================================================

st.set_page_config(layout="wide")

st.title("ü§ñ CorePath OS")

# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è ---
if 'client_profile' not in st.session_state:
    st.session_state.client_profile = None 
if 'product_ladder' not in st.session_state:
    st.session_state.product_ladder = None
if 'script_history' not in st.session_state:
    st.session_state.script_history = []
if 'current_script' not in st.session_state:
    st.session_state.current_script = None
if 'tasks' not in st.session_state:
    st.session_state.tasks = []
# --- –ù–û–í–´–ô –ë–õ–û–ö: –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞ ---
if 'interview_answers' not in st.session_state:
    st.session_state.interview_answers = {}
if 'current_q_index' not in st.session_state:
    st.session_state.current_q_index = 0
if 'current_conversation' not in st.session_state:
    st.session_state.current_conversation = []
if 'profile_generated' not in st.session_state:
    st.session_state.profile_generated = False

# --- –£–õ–£–ß–®–ï–ù–ò–ï: –õ–û–ì–ò–ö–ê –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –°–¢–ê–†–¢–û–í–û–ì–û –≠–ö–†–ê–ù–ê –ò–õ–ò –†–ê–ë–û–ß–ï–ì–û –ü–†–û–°–¢–†–ê–ù–°–¢–í–ê ---

if not st.session_state.profile_generated:
    # --- –≠–¢–ê–ü 1: –°–¢–ê–†–¢–û–í–´–ô –≠–ö–†–ê–ù –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ---
    with st.expander("üöÄ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞", expanded=True): # –†–∞–∫–µ—Ç–∞
        api_key = st.text_input("üîë –í–∞—à Gemini API –ö–ª—é—á", type="password", help="–í–∞—à –∫–ª—é—á –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏ –∏ –Ω–∏–≥–¥–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.", key="api_key_input")
        
        # --- –£–õ–£–ß–®–ï–ù–ò–ï: –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –≤–≤–æ–¥–∞ ---
        input_mode_tab1, input_mode_tab2 = st.tabs(["–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –û–ø—Ä–æ—Å", "–ë—ã—Å—Ç—Ä—ã–π –í–≤–æ–¥ (–¥–ª—è –æ–ø—ã—Ç–Ω—ã—Ö)"])

        with input_mode_tab1:
            st.markdown("–û—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –≤ –¥–∏–∞–ª–æ–≥–µ —Å AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –≥–ª—É–±–∏–Ω—ã.")
        
        # --- –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–û–ì–û –û–ü–†–û–°–ê ---
        all_questions = [(k, v) for block in QUESTIONNAIRE_QUESTIONS.values() for k, v in block.items()]
        
        # --- –£–õ–£–ß–®–ï–ù–ò–ï: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ –ø–µ—Ä–≤–æ–≥–æ –±–ª–æ–∫–∞ ---
        if st.session_state.current_q_index < len(all_questions): # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–∫–æ–Ω—á–µ–Ω –ª–∏ –æ–ø—Ä–æ—Å
            q_key, q_text = all_questions[st.session_state.current_q_index]

            st.subheader(f"–í–æ–ø—Ä–æ—Å {st.session_state.current_q_index + 1} / {len(all_questions)}")
            st.markdown(f"**{q_text}**")

            # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞
            for i, (speaker, text) in enumerate(st.session_state.current_conversation):
                if speaker == "user":
                    st.chat_message("user").write(text)
                else:
                    st.chat_message("assistant").write(text)

            # –ü–æ–ª–µ –¥–ª—è –æ—Ç–≤–µ—Ç–∞
            user_answer = st.text_area("–í–∞—à –æ—Ç–≤–µ—Ç:", key=f"interview_input_{q_key}", height=150)

            if st.button("üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å", key=f"submit_{q_key}"):
                if user_answer:
                    # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –¥–∏–∞–ª–æ–≥
                    st.session_state.current_conversation.append(("user", user_answer))
                    
                    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å
                    interview_engine = InterviewEngine(api_key=st.session_state.api_key_input)
                    conversation_str = "\n".join([f"{s}: {t}" for s, t in st.session_state.current_conversation])
                    follow_up = interview_engine.get_follow_up_question(q_text, conversation_str)
                    
                    if follow_up:
                        st.session_state.current_conversation.append(("ai", follow_up))
                    
                    st.rerun()

            if st.button("‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É", type="primary"):
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Å—å –¥–∏–∞–ª–æ–≥ –∫–∞–∫ –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –≤–æ–ø—Ä–æ—Å
                final_answer_text = "\n".join([f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {t}" if s == "user" else f"AI-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç: {t}" for s, t in st.session_state.current_conversation])
                st.session_state.interview_answers[q_key] = final_answer_text
                
                # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
                st.session_state.current_conversation = []
                st.session_state.current_q_index += 1
                st.rerun()
        else:
            st.success("üéâ –û–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω! –í—Å–µ –æ—Ç–≤–µ—Ç—ã —Å–æ–±—Ä–∞–Ω—ã.")
            st.info("–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤.")

        run_from_questionnaire = st.button("üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –ø–æ –æ—Ç–≤–µ—Ç–∞–º", disabled=(st.session_state.current_q_index < len(all_questions)))

        with input_mode_tab2:
            raw_text_area = st.text_area("–®–∞–≥ 1: –í—Å—Ç–∞–≤—å—Ç–µ –ï–¥–∏–Ω—ã–π –ö–æ–Ω—Ç–µ–∫—Å—Ç", height=250, key="raw_text", placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–µ—Å—å —Ç–µ–∫—Å—Ç –∏–∑ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞, –≤–∫–ª—é—á–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ –∏ –æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞—Ö...")
            run_from_text = st.button("üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –∏ –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ")

    if run_from_questionnaire or run_from_text:
            with st.spinner("–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–∞–Ω–Ω—ã–µ..."):
                
                # 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —Ç–µ–∫—Å—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
                if run_from_questionnaire:
                    # –°–æ–±–∏—Ä–∞–µ–º –æ—Ç–≤–µ—Ç—ã –≤ –µ–¥–∏–Ω—ã–π —Ç–µ–∫—Å—Ç
                    full_text = ""
                    for block_title, questions in QUESTIONNAIRE_QUESTIONS.items():
                        full_text += f"\n\n--- {block_title} ---\n\n"
                        for q_key, q_text in questions.items():
                            answer = st.session_state.interview_answers.get(q_key, "").strip()
                            if answer: # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–≤–µ—Ç
                                full_text += f"–í–æ–ø—Ä–æ—Å: {q_text}\n\n--- –ù–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞ ---\n{answer}\n--- –ö–æ–Ω–µ—Ü –¥–∏–∞–ª–æ–≥–∞ ---\n\n"
                    st.session_state.raw_text = full_text

                # 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–≤–∏–∂–∫–æ–≤
                api_key = st.session_state.api_key_input
                ingestion_engine = IngestionEngine(api_key=api_key)
                blue_ocean_engine = BlueOceanEngine(api_key=api_key)
                harmony_engine = HarmonyDiagnosticEngine()
                strategy_engine = StrategyEngine(api_key=api_key)
                commerce_engine = CommerceEngine(api_key=api_key)
            
                # 3. –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω–≤–µ–π–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏
                try:
                    profile = ingestion_engine.process(st.session_state.raw_text)
                    if not profile:
                        st.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –∏–ª–∏ —Ç–µ–∫—Å—Ç –æ–ø—Ä–æ—Å–Ω–∏–∫–∞.")
                        st.stop()
                    
                    matrix = blue_ocean_engine.process(st.session_state.raw_text, profile)
                    if not matrix:
                        st.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ú–∞—Ç—Ä–∏—Ü—É 4-—Ö –î–µ–π—Å—Ç–≤–∏–π.")
                        st.stop()
                    profile.positioning_matrix = matrix
                    
                    strategy_data = strategy_engine.process(profile)
                    if not strategy_data:
                        st.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Roadmap.")
                        st.stop()
                    profile.strategic_goals = strategy_data

                    product_ladder = commerce_engine.process(profile)
                    if not product_ladder:
                        st.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –õ–µ—Å—Ç–Ω–∏—Ü—É –¶–µ–Ω–Ω–æ—Å—Ç–∏ –ü—Ä–æ–¥—É–∫—Ç–∞.")
                        st.stop()

                except ValueError as e:
                    if "PROHIBITED_CONTENT" in str(e):
                        st.error("–í—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏. –ú—ã –∑–∞–±–æ—Ç–∏–º—Å—è –æ —á–∏—Å—Ç–æ—Ç–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–π –∏ –∑–∞ –∫—É–ª—å—Ç—É—Ä–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ. –ü–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π—Ç–µ —Å–≤–æ–π –æ—Ç–≤–µ—Ç.")
                    else:
                        st.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
                    st.stop()

                # 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏
                st.session_state.client_profile = harmony_engine.process(profile)
                st.session_state.scenario_producer = AIScenarioProducer(api_key=api_key)
                st.session_state.calendar_engine = CalendarEngine(api_key=api_key)
                st.session_state.client_profile.products = [asdict(p) for p in [product_ladder.lead_magnet, product_ladder.tripwire, product_ladder.core_offer, product_ladder.high_ticket] if p]
                st.session_state.product_ladder = product_ladder
                
                # 5. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω
                st.session_state.profile_generated = True
                st.rerun()

    # --- –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –Ω–∞ —Å—Ç–∞—Ä—Ç–æ–≤–æ–º —ç–∫—Ä–∞–Ω–µ ---
    uploaded_file = st.file_uploader("...–∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å", type=["json"])
    if uploaded_file is not None:
        data = json.load(uploaded_file)
        # ... (–ª–æ–≥–∏–∫–∞ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–æ–π –∂–µ)
        profile = ClientProfileHub(**data)
        st.session_state.client_profile = profile
        st.session_state.profile_generated = True
        st.rerun()

else:
    # --- –≠–¢–ê–ü 2: –û–°–ù–û–í–ù–û–ï –†–ê–ë–û–ß–ï–ï –ü–†–û–°–¢–†–ê–ù–°–¢–í–û ---
    col1, col2 = st.columns([1, 3]) # –î–µ–ª–∞–µ–º –ª–µ–≤—É—é –∫–æ–ª–æ–Ω–∫—É —É–∂–µ

    with col1:
        st.header("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ")

        # --- –ë–ª–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–∑–∞–≥—Ä—É–∑–∫–∏ ---
        with st.expander("‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü—Ä–æ—Ñ–∏–ª–µ–º", expanded=True):
            # –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            def render_download_button():
                if st.session_state.client_profile:
                    profile_dict = asdict(st.session_state.client_profile)
                    # ... (–ª–æ–≥–∏–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö)
                    profile_json = json.dumps(profile_dict, indent=2, ensure_ascii=False, default=str).encode('utf-8')
                    st.download_button(
                        label="‚¨áÔ∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å",
                        data=profile_json,
                        file_name=f"corepath_profile_{st.session_state.client_profile.brand_name}.json",
                        mime="application/json",
                    )
                else:
                    st.button("‚¨áÔ∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å", disabled=True)
            
            render_download_button()

        # --- –ë–ª–æ–∫ –ø–æ–∏—Å–∫–∞ ---
        with st.expander("–ü–æ–∏—Å–∫ –ø–æ –ø—Ä–æ–µ–∫—Ç—É"):
            search_term = st.text_input("–ù–∞–π—Ç–∏...", label_visibility="collapsed")
            # ... (–ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞)

        # --- –ë–ª–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ---
        with st.expander("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ü—Ä–æ—Ñ–∏–ª—å"):
            profile = st.session_state.client_profile
            with st.form(key='profile_edit_form'):
                # ... (—Ñ–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
                st.form_submit_button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è")

    with col2:
        st.header(" ") # –ü—É—Å—Ç–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
        
        tab0, tab1, tab2, tab3, tab4, tab5, tab6 = st.tabs(["üìä –î–∞—à–±–æ—Ä–¥", "üß≠ –°—Ç—Ä–∞—Ç–µ–≥–∏—è", "üì¶ –ü—Ä–æ–¥—É–∫—Ç—ã (–ü–¢–£)", "üé¨ –ö–æ–Ω—Ç–µ–Ω—Ç", "üìã –ó–∞–¥–∞—á–∏", "üíº –ö–∞–ø–∏—Ç–∞–ª", "üë• –ö–æ–º–∞–Ω–¥–∞"])

        def generate_notifications():
            notifications = []
            today = date.today()
            
            for task in st.session_state.tasks:
                # 1. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–µ–¥–ª–∞–π–Ω–∞—Ö
                if task.deadline and task.status != "Done":
                    delta = (task.deadline - today).days
                    if 0 <= delta <= 3:
                        notifications.append(f"üóìÔ∏è –ü—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è –¥–µ–¥–ª–∞–π–Ω –∑–∞–¥–∞—á–∏ ¬´{task.description}¬ª (–æ—Å—Ç–∞–ª–æ—Å—å {delta} –¥–Ω.)")
                    elif delta < 0:
                        notifications.append(f"üî• –ó–∞–¥–∞—á–∞ ¬´{task.description}¬ª –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–∞ –Ω–∞ {-delta} –¥–Ω.")

                # 2. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö
                for comment in task.comments:
                    if comment.author != "–Ø": # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ "–Ø" - —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                        notifications.append(f"üí¨ –ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–¥–∞—á–µ ¬´{task.description}¬ª –æ—Ç {comment.author}: {comment.text}")
            return notifications

        # --- –ù–û–í–´–ô –ë–õ–û–ö: –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ---
        notifications = generate_notifications()
        if notifications:
            st.subheader("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è")
            for notification in notifications:
                st.warning(notification)
            st.markdown("---")

        with tab0:
            st.subheader("–î–∞—à–±–æ—Ä–¥ –ü—Ä–æ–µ–∫—Ç–∞")

            if 'tasks' in st.session_state and st.session_state.tasks:
                tasks = st.session_state.tasks
                total_tasks = len(tasks)
                done_tasks = len([t for t in tasks if t.status == 'Done'])
                in_progress_tasks = len([t for t in tasks if t.status == 'In Progress'])
                todo_tasks = len([t for t in tasks if t.status == 'To Do'])
                overdue_tasks = len([t for t in tasks if t.deadline and t.deadline < date.today() and t.status != 'Done'])
                
                completion_percentage = done_tasks / total_tasks if total_tasks > 0 else 0

                st.markdown("#### –û–±—â–∏–π –ü—Ä–æ–≥—Ä–µ—Å—Å")
                st.progress(completion_percentage)
                st.write(f"**–í—ã–ø–æ–ª–Ω–µ–Ω–æ {done_tasks} –∏–∑ {total_tasks} –∑–∞–¥–∞—á ({completion_percentage:.0%})**")

                st.markdown("---")
                
                st.markdown("#### –ö–ª—é—á–µ–≤—ã–µ –ú–µ—Ç—Ä–∏–∫–∏")
                m_col1, m_col2, m_col3, m_col4 = st.columns(4)
                with m_col1:
                    st.metric("‚úîÔ∏è –í—ã–ø–æ–ª–Ω–µ–Ω–æ", done_tasks)
                with m_col2:
                    st.metric("‚è≥ –í –†–∞–±–æ—Ç–µ", in_progress_tasks)
                with m_col3:
                    st.metric("üìã –ö –í—ã–ø–æ–ª–Ω–µ–Ω–∏—é", todo_tasks)
                with m_col4:
                    st.metric("üî• –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ", overdue_tasks, delta=overdue_tasks, delta_color="inverse")

                st.markdown("---")
                st.markdown("#### –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ó–∞–¥–∞—á")

                try:
                    import pandas as pd
                    
                    # –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
                    status_data = pd.DataFrame({
                        '–°—Ç–∞—Ç—É—Å': ['–ö –í—ã–ø–æ–ª–Ω–µ–Ω–∏—é', '–í –†–∞–±–æ—Ç–µ', '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'],
                        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': [todo_tasks, in_progress_tasks, done_tasks]
                    })
                    st.bar_chart(status_data.set_index('–°—Ç–∞—Ç—É—Å'))

                    # –ì—Ä–∞—Ñ–∏–∫ –ø–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º
                    if st.session_state.client_profile.team:
                        responsibles_data = pd.DataFrame([t.responsible for t in tasks if t.responsible], columns=['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'])
                        if not responsibles_data.empty:
                            st.write("#### –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º")
                            st.bar_chart(responsibles_data['–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π'].value_counts())

                except ImportError:
                    st.warning("–î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É pandas: `pip install pandas`")
            else:
                st.info("–°–æ–∑–¥–∞–π—Ç–µ –ø–ª–∞–Ω –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ '–ó–∞–¥–∞—á–∏', —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.")

        with tab1: # –°—Ç—Ä–∞—Ç–µ–≥–∏—è
            st.subheader("–û—Ç—á–µ—Ç –æ –ì–∞—Ä–º–æ–Ω–∏–∏")
            report_text = st.session_state.client_profile.harmony_report.get("report_text", "–û—Ç—á–µ—Ç –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.")
            if "–ö–æ–Ω—Ñ–ª–∏–∫—Ç" in report_text:
                st.warning(report_text)
                with st.expander("–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç?"):
                    st.info("""
                        **–≠—Ç–æ –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞, –∞ —Ç–æ—á–∫–∞ —Ä–æ—Å—Ç–∞.** –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç ‚Äî —ç—Ç–æ —Å–∫—Ä—ã—Ç–æ–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ –º–µ–∂–¥—É –≤–∞—à–∏–º–∏ —Ü–µ–ª—è–º–∏ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞–º–∏ (–≤–∞—à–∏–º–∏ "–≤—Ä–∞–≥–∞–º–∏").
                        
                        –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç –µ–≥–æ, —á—Ç–æ–±—ã –≤—ã –º–æ–≥–ª–∏ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —ç—Ç–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ –≤ **—É–Ω–∏–∫–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é**. –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –±–æ—Ä–æ—Ç—å—Å—è —Å "–≤—Ä–∞–≥–æ–º", –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ —Ç–æ–ø–ª–∏–≤–æ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤—Ç–æ—Ä–æ–π, –±–æ–ª–µ–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Ü–µ–ª–∏. –≠—Ç–æ –æ—Å–Ω–æ–≤–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∏–ª—å–Ω–æ–≥–æ, –Ω–µ–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
                        """)
            else:
                st.success(report_text)

            st.markdown("---")
            st.subheader("üó∫Ô∏è –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∞—è –ö–∞—Ä—Ç–∞")
            with st.expander("–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?"):
                st.info("–≠—Ç–∞ –∫–∞—Ä—Ç–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, **—á—Ç–æ** –¥–µ–ª–∞—Ç—å –∏ **–¥–ª—è –∫–æ–≥–æ**. **Roadmap** ‚Äî —ç—Ç–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–µ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤–∞—à–∏—Ö —Ü–µ–ª–µ–π. **–ö–∞—Ä—Ç–∞ –°—Ç–µ–π–∫—Ö–æ–ª–¥–µ—Ä–æ–≤** ‚Äî —ç—Ç–æ 5 –∫–ª—é—á–µ–≤—ã—Ö –≥—Ä—É–ø–ø –∞—É–¥–∏—Ç–æ—Ä–∏–∏, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –Ω—É–∂–Ω–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ. –≠—Ç–æ –≤–∞—à –∫–æ–º–ø–∞—Å –≤ –º–∏—Ä–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ –Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥–∞.")

            if st.session_state.client_profile.strategic_goals:
                strategy_data = st.session_state.client_profile.strategic_goals
                st.markdown("#### –î–æ—Ä–æ–∂–Ω–∞—è –ö–∞—Ä—Ç–∞ (Roadmap)")
                for item in strategy_data.get("roadmap", []):
                    st.checkbox(f"**–®–∞–≥ {item['step']}: {item['title']}** - {item['description']} (–¶–µ–ª—å: {', '.join(item['target_groups'])})", key=f"roadmap_{item['step']}")

                with st.expander("üë• –ö–∞—Ä—Ç–∞ –°—Ç–µ–π–∫—Ö–æ–ª–¥–µ—Ä–æ–≤ (5 –ì—Ä—É–ø–ø –¶–ê)"):
                    for group, description in strategy_data.get("audience_groups", {}).items():
                        st.markdown(f"**{group}**")
                        st.write(description)
            
            st.markdown("---")
            st.subheader("–ú–∞—Ç—Ä–∏—Ü–∞ 4-—Ö –î–µ–π—Å—Ç–≤–∏–π")
            with st.expander("–í —á–µ–º —Å—É—Ç—å —ç—Ç–æ–π –º–∞—Ç—Ä–∏—Ü—ã?"):
                st.info("""
                    –≠—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏–∑ "–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ì–æ–ª—É–±–æ–≥–æ –û–∫–µ–∞–Ω–∞", –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å—Ç—Ä–æ–∏—Ç—å—Å—è –æ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤. –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –∫–æ–Ω–∫—É—Ä–∏—Ä–æ–≤–∞—Ç—å "–≤ –ª–æ–±", –º—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º, —á—Ç–æ –≤ –≤–∞—à–µ–π –Ω–∏—à–µ –º–æ–∂–Ω–æ:
                    - **–£–ø—Ä–∞–∑–¥–Ω–∏—Ç—å:** –û—Ç –∫–∞–∫–∏—Ö –æ–±—â–µ–ø—Ä–∏–Ω—è—Ç—ã—Ö, –Ω–æ –Ω–µ–Ω—É–∂–Ω—ã—Ö –≤–µ—â–µ–π –º–æ–∂–Ω–æ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è?
                    - **–°–Ω–∏–∑–∏—Ç—å:** –ß—Ç–æ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –º–µ–Ω—å—à–µ, —á–µ–º –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã?
                    - **–ü–æ–≤—ã—Å–∏—Ç—å:** –ö–∞–∫–∏–µ –≤–∞–∂–Ω—ã–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –≤–µ—â–∏ –Ω—É–∂–Ω–æ —É—Å–∏–ª–∏—Ç—å?
                    - **–°–æ–∑–¥–∞—Ç—å:** –ß—Ç–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ –Ω–æ–≤–æ–≥–æ –º–æ–∂–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä—ã–Ω–∫—É, —á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç –Ω–∏–∫—Ç–æ?
                    –û—Ç–≤–µ—Ç—ã –Ω–∞ —ç—Ç–∏ –≤–æ–ø—Ä–æ—Å—ã —Ñ–æ—Ä–º–∏—Ä—É—é—Ç –≤–∞—à–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ.
                    """)
            if st.session_state.client_profile.positioning_matrix:
                matrix = st.session_state.client_profile.positioning_matrix
                mat_col1, mat_col2 = st.columns(2)
                with mat_col1:
                    st.markdown("##### –£–ø—Ä–∞–∑–¥–Ω–∏—Ç—å")
                    st.write("\n".join(f"- {item}" for item in matrix.get("eliminate", ["-"])))
                    st.markdown("##### –ü–æ–≤—ã—Å–∏—Ç—å")
                    st.write("\n".join(f"- {item}" for item in matrix.get("raise", ["-"])))
                with mat_col2:
                    st.markdown("##### –°–Ω–∏–∑–∏—Ç—å")
                    st.write("\n".join(f"- {item}" for item in matrix.get("reduce", ["-"])))
                    st.markdown("##### –°–æ–∑–¥–∞—Ç—å")
                    st.write("\n".join(f"- {item}" for item in matrix.get("create", ["-"])))

            with st.expander("–ü–æ–∫–∞–∑–∞—Ç—å –∏—Ç–æ–≥–æ–≤—ã–π Client_Profile_Hub (JSON)", expanded=False):
                st.json(asdict(st.session_state.client_profile))

        with tab2: # –ü—Ä–æ–¥—É–∫—Ç—ã
            if st.session_state.product_ladder:
                st.subheader("üí∞ –õ–µ—Å—Ç–Ω–∏—Ü–∞ –¶–µ–Ω–Ω–æ—Å—Ç–∏ –ü—Ä–æ–¥—É–∫—Ç–∞ (–ü–¢–£)")
                with st.expander("–ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–∞—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤–∞—è –ª–∏–Ω–µ–π–∫–∞?"):
                    st.info("""
                        "–ü—Ä–æ–¥—É–∫—Ç–æ–≤–æ-–¢–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ" (–ü–¢–£) –ø—Ä–æ–µ–∫—Ç–∏—Ä—É–µ—Ç –ª–∏–Ω–µ–π–∫—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ—à–∞–µ—Ç –¥–≤–µ –∑–∞–¥–∞—á–∏: **–º–∞–∫—Å–∏–º–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–∏–±—ã–ª—å** –∏ **—Å–Ω–∏–∂–∞–µ—Ç –≤–∞—à–µ –≤—ã–≥–æ—Ä–∞–Ω–∏–µ**.
                        - **Lead Magnet** –ø—Ä–∏–≤–ª–µ–∫–∞–µ—Ç –≤–Ω–∏–º–∞–Ω–∏–µ.
                        - **Tripwire** –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ –≤ –∫–ª–∏–µ–Ω—Ç–∞ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º —Å—Ç—Ä–µ—Å—Å–æ–º.
                        - **Core Offer** –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ—Ö–æ–¥.
                        - **High-Ticket** —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Å–∞–º—ã–º–∏ –ª–æ—è–ª—å–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏, –ø—Ä–∏–Ω–æ—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å –∏ –≤–∞–º, –∏ –∏–º.
                        –≠—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∞–º —Ä–∞–±–æ—Ç–∞—Ç—å –º–µ–Ω—å—à–µ, –∞ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–æ–ª—å—à–µ, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä—É—è—Å—å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ü–µ–Ω–Ω–æ—Å—Ç–∏, –∞ –Ω–µ –Ω–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂–∞—Ö.
                        """)
                with st.expander("üí∞ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –õ–µ—Å—Ç–Ω–∏—Ü—É –¶–µ–Ω–Ω–æ—Å—Ç–∏ –ü—Ä–æ–¥—É–∫—Ç–∞ (–ü–¢–£)", expanded=True):
                    ladder = st.session_state.product_ladder
                    with st.form(key='pvl_edit_form'):
                        # ... (–∫–æ–¥ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ü–¢–£ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
                        st.markdown("#### Lead Magnet (–ë–µ—Å–ø–ª–∞—Ç–Ω–∏–∫)")
                        lm_name = st.text_input("–ù–∞–∑–≤–∞–Ω–∏–µ Lead Magnet", value=ladder.lead_magnet.name if ladder.lead_magnet else "")
                        lm_purpose = st.text_input("–¶–µ–ª—å Lead Magnet", value=ladder.lead_magnet.purpose if ladder.lead_magnet else "")
                        st.markdown("#### Tripwire (–¢—Ä–∏–ø–≤–∞–π–µ—Ä)")
                        tw_name = st.text_input("–ù–∞–∑–≤–∞–Ω–∏–µ Tripwire", value=ladder.tripwire.name if ladder.tripwire else "")
                        tw_price = st.number_input("–¶–µ–Ω–∞ Tripwire", value=ladder.tripwire.price if ladder.tripwire else 0.0, format="%.2f")
                        tw_purpose = st.text_input("–¶–µ–ª—å Tripwire", value=ladder.tripwire.purpose if ladder.tripwire else "")
                        st.markdown("#### Core Offer (–û—Å–Ω–æ–≤–Ω–æ–π –ü—Ä–æ–¥—É–∫—Ç)")
                        co_name = st.text_input("–ù–∞–∑–≤–∞–Ω–∏–µ Core Offer", value=ladder.core_offer.name if ladder.core_offer else "")
                        co_price = st.number_input("–¶–µ–Ω–∞ Core Offer", value=ladder.core_offer.price if ladder.core_offer else 0.0, format="%.2f")
                        co_purpose = st.text_input("–¶–µ–ª—å Core Offer", value=ladder.core_offer.purpose if ladder.core_offer else "")
                        st.markdown("#### High-Ticket (–§–ª–∞–≥–º–∞–Ω)")
                        ht_name = st.text_input("–ù–∞–∑–≤–∞–Ω–∏–µ High-Ticket", value=ladder.high_ticket.name if ladder.high_ticket else "")
                        ht_price = st.number_input("–¶–µ–Ω–∞ High-Ticket", value=ladder.high_ticket.price if ladder.high_ticket else 0.0, format="%.2f")
                        ht_purpose = st.text_input("–¶–µ–ª—å High-Ticket", value=ladder.high_ticket.purpose if ladder.high_ticket else "")
                        pvl_submitted = st.form_submit_button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç–æ–≤—É—é –ª–∏–Ω–µ–π–∫—É")
                        if pvl_submitted:
                            if ladder.lead_magnet: ladder.lead_magnet.name, ladder.lead_magnet.purpose = lm_name, lm_purpose
                            if ladder.tripwire: ladder.tripwire.name, ladder.tripwire.price, ladder.tripwire.purpose = tw_name, tw_price, tw_purpose
                            if ladder.core_offer: ladder.core_offer.name, ladder.core_offer.price, ladder.core_offer.purpose = co_name, co_price, co_purpose
                            if ladder.high_ticket: ladder.high_ticket.name, ladder.high_ticket.price, ladder.high_ticket.purpose = ht_name, ht_price, ht_purpose
                            st.session_state.client_profile.products = [asdict(p) for p in [ladder.lead_magnet, ladder.tripwire, ladder.core_offer, ladder.high_ticket] if p and p.name]
                            st.success("–õ–µ—Å—Ç–Ω–∏—Ü–∞ –¶–µ–Ω–Ω–æ—Å—Ç–∏ –ü—Ä–æ–¥—É–∫—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!")

                st.markdown("---")
                st.subheader("üßÆ –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –í–æ—Ä–æ–Ω–∫–∏ –ü—Ä–æ–¥–∞–∂")
                # ... (–∫–æ–¥ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
                ladder = st.session_state.product_ladder
                target_revenue = st.number_input("–ñ–µ–ª–∞–µ–º—ã–π –î–æ—Ö–æ–¥ (–≤ –º–µ—Å—è—Ü)", min_value=0, value=10000)
                traffic = st.number_input("–¢—Ä–∞—Ñ–∏–∫ (–ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ –≤ –º–µ—Å.)", min_value=0, value=5000)
                st.markdown("---")
                c1 = st.slider("–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –ª–∏–¥—ã (C1, %)", 0, 100, 20) / 100.0
                c2 = st.slider("–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏ —Ç—Ä–∏–ø–≤–∞–π–µ—Ä–∞ (C2, %)", 0, 100, 5) / 100.0
                c3 = st.slider("–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏ Core Offer (C3, %)", 0, 100, 20) / 100.0
                leads = traffic * c1
                tripwire_buyers = leads * c2
                core_offer_buyers = tripwire_buyers * c3
                tripwire_revenue = tripwire_buyers * (ladder.tripwire.price if ladder.tripwire else 0)
                core_offer_revenue = core_offer_buyers * (ladder.core_offer.price if ladder.core_offer else 0)
                total_revenue = tripwire_revenue + core_offer_revenue
                st.markdown("---")
                st.subheader("–ü—Ä–æ–≥–Ω–æ–∑ –†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
                res_col1, res_col2, res_col3 = st.columns(3) 
                with res_col1: st.metric("–õ–∏–¥—ã", f"{int(leads):,}")
                with res_col2: st.metric("–ü–æ–∫—É–ø–∞—Ç–µ–ª–∏ (Core Offer)", f"{int(core_offer_buyers):,}")
                with res_col3: st.metric(label="–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π –î–æ—Ö–æ–¥", value=f"${int(total_revenue):,}", delta=f"${int(total_revenue - target_revenue):,}")
                st.progress(min(total_revenue / target_revenue, 1.0))
                st.write(f"–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ü–µ–ª–∏: {total_revenue / target_revenue:.1%}")
                with st.expander("–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç"):
                    st.write(f"–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏: {int(traffic):,}")
                    st.write(f"–õ–∏–¥—ã (C1 = {c1:.1%}): {int(leads):,}")
                    st.write(f"–ü–æ–∫—É–ø–∞—Ç–µ–ª–∏ –¢—Ä–∏–ø–≤–∞–π–µ—Ä–∞ (C2 = {c2:.1%}): {int(tripwire_buyers):,}")
                    st.write(f"–î–æ—Ö–æ–¥ —Å –¢—Ä–∏–ø–≤–∞–π–µ—Ä–∞: ${int(tripwire_revenue):,}")
                    st.write(f"–ü–æ–∫—É–ø–∞—Ç–µ–ª–∏ Core Offer (C3 = {c3:.1%}): {int(core_offer_buyers):,}")
                    st.write(f"–î–æ—Ö–æ–¥ —Å Core Offer: ${int(core_offer_revenue):,}")
                    st.write(f"**–ò—Ç–æ–≥–æ–≤—ã–π –¥–æ—Ö–æ–¥:** **${int(total_revenue):,}**")

        with tab3: # –ö–æ–Ω—Ç–µ–Ω—Ç
            with st.form("scenario_constructor_form"):
                st.subheader("üõ†Ô∏è –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –°—Ü–µ–Ω–∞—Ä–∏—è")
                # ... (–∫–æ–¥ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
                idea = st.text_input("1. –ò–¥–µ—è (–û —á—ë–º?)", placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ —Ç–≤–æ—Ä—á–µ—Å–∫–æ–≥–æ —Å—Ç—É–ø–æ—Ä–∞")
                content_carrier = st.selectbox("2. –ö–æ–Ω—Ç–µ–Ω—Ç-–Ω–æ—Å–∏—Ç–µ–ª—å", ANCHOR_POINTS_DATA["content_carriers"])
                format_tone = st.selectbox("3. –§–æ—Ä–º–∞—Ç-—Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å", ANCHOR_POINTS_DATA["formats"])
                # ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞)
                blog_genre = st.selectbox("4. –ñ–∞–Ω—Ä –ë–ª–æ–≥–∞ (–í–∏–¥–µ–æ—Ñ–æ—Ä–º–∞—Ç)", ANCHOR_POINTS_DATA["blog_genres"])
                extras_triggers = st.multiselect("5. –î–æ–ø—ã/–¢—Ä–∏–≥–≥–µ—Ä—ã (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)", ANCHOR_POINTS_DATA["extras_triggers"])
                movie_genre = st.selectbox("6. –ñ–∞–Ω—Ä –ö–∏–Ω–æ (–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞)", ANCHOR_POINTS_DATA["movie_genres"])
                tv_genre = st.selectbox("7. –¢–í –ñ–∞–Ω—Ä (–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ã–ø—É—Å–∫–∞)", ANCHOR_POINTS_DATA["tv_genres"])
                
                # –£–ª—É—á—à–µ–Ω–∏–µ: –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª—è "–ü–µ—Ä—Å–æ–Ω–∞–∂"
                character_default = st.session_state.client_profile.brand_name if st.session_state.client_profile else ""
                character = st.text_input("8. –ü–µ—Ä—Å–æ–Ω–∞–∂/–ù–∏—à–∞", value=character_default)
                product_names = ["(–ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–∞)"] + [p['name'] for p in st.session_state.client_profile.products]
                selected_product_name = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):", product_names)
                submitted = st.form_submit_button("üé¨ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –°—Ü–µ–Ω–∞—Ä–∏–π")
                if submitted:
                    with st.spinner("–°–æ–∑–¥–∞—é –º–∞–≥–∏—é –ø–æ 8 —Ç–æ—á–∫–∞–º..."):
                        # –ü–æ–ª—É—á–∞–µ–º scenario_producer –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Å—Å–∏–∏
                        scenario_producer = st.session_state.get('scenario_producer')
                        if not scenario_producer:
                            st.error("–û—à–∏–±–∫–∞: –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –∑–∞–Ω–æ–≤–æ.")
                            st.stop()
                        product_to_promote = None
                        if selected_product_name != "(–ù–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–∞)" and st.session_state.product_ladder:
                            all_products = [st.session_state.product_ladder.lead_magnet, st.session_state.product_ladder.tripwire, st.session_state.product_ladder.core_offer, st.session_state.product_ladder.high_ticket]
                            product_to_promote = next((p for p in all_products if p and p.name == selected_product_name), None)
                        selected_points = {
                            "idea": idea, "content_carrier": content_carrier, "format": format_tone,
                            "blog_genre": blog_genre, "extras_triggers": extras_triggers,
                            "movie_genre": movie_genre, "tv_genre": tv_genre, "character": character
                        }
                        script = scenario_producer.process(st.session_state.client_profile, selected_points, product_to_promote)
                    if script:
                        # –°–æ—Ö—Ä–∞–Ω—è–µ–º content_carrier –¥–ª—è –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏
                        script["content_carrier_ref"] = content_carrier
                        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –∏ –¥–µ–ª–∞–µ–º —Ç–µ–∫—É—â–∏–º
                        st.session_state.script_history.append(script)
                        st.session_state.current_script = script
                    else:
                        st.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

            if st.session_state.current_script:
                script_data = st.session_state.current_script
                st.subheader(f"–°—Ü–µ–Ω–∞—Ä–∏–π: ¬´{script_data.get('title', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}¬ª")
                st.markdown("##### ‚ö°Ô∏è 1. –®–û–ö (0.5—Å)"); st.info(script_data.get('shock', ''))
                st.markdown("##### üé£ 2. –•–£–ö (3—Å)"); st.info(script_data.get('hook', ''))
                st.markdown("##### üì¶ 3. –ö–û–ù–¢–ï–ù–¢ (15—Å)"); st.info(script_data.get('content', ''))
                st.markdown("##### 4. CTA (–ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é)"); st.success(script_data.get('cta', ''))

        with tab4: # –ó–∞–¥–∞—á–∏
            st.subheader("–î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –≤ –ó–∞–¥–∞—á–∏")

            # --- –ù–û–í–´–ô –ë–õ–û–ö: –í–´–ë–û–† –°–¶–ï–ù–ê–†–ò–Ø –î–õ–Ø –î–ï–ö–û–ú–ü–û–ó–ò–¶–ò–ò ---
            if st.session_state.script_history:
                history_options = {f"–°—Ü–µ–Ω–∞—Ä–∏–π #{i+1}: {s.get('title', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}": i for i, s in enumerate(st.session_state.script_history)}
                selected_script_title = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞:", options=history_options.keys())
                
                # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏
                selected_script_index = history_options[selected_script_title]
                script_to_decompose = st.session_state.script_history[selected_script_index]

                if st.button("üìÖ –°–æ–∑–¥–∞—Ç—å –ü–ª–∞–Ω –ü—Ä–æ–µ–∫—Ç–∞"):
                    with st.spinner("–ü–ª–∞–Ω–∏—Ä—É—é –∑–∞–¥–∞—á–∏..."):
                        calendar_engine = st.session_state.get('calendar_engine')
                        if not calendar_engine:
                            st.error("–û—à–∏–±–∫–∞: –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –¥–≤–∏–∂–æ–∫ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –∑–∞–Ω–æ–≤–æ.")
                            st.stop()

                        # –ò—â–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ "8 —Ç–æ—á–µ–∫" –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
                        original_anchor_points = st.session_state.script_history[selected_script_index].get('anchor_points_ref', {})
                        
                        tasks = calendar_engine.decompose_script_to_tasks(script_to_decompose, original_anchor_points)
                        st.session_state.tasks = tasks
                        if tasks:
                            st.success(f"AI —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª {len(tasks)} –∑–∞–¥–∞—á –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞!")
            else:
                st.warning("–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π –≤–æ –≤–∫–ª–∞–¥–∫–µ '–ö–æ–Ω—Ç–µ–Ω—Ç'.")

            if 'tasks' in st.session_state and st.session_state.tasks:
                st.markdown("---")
                st.subheader("–ö–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∞")
                # ... (–∫–æ–¥ –ö–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∏ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
                if 'editing_task_index' not in st.session_state:
                    st.session_state.editing_task_index = None
                def display_task(task, index):
                    # –°–ø–∏—Å–æ–∫ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ç–µ–ø–µ—Ä—å —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ –º–æ–¥—É–ª—è
                    team_members = st.session_state.client_profile.team
                    if team_members:
                        responsibles = [""] + [member.name for member in team_members]
                    else:
                        responsibles = [""]
                    
                    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–ö–ò: –ë–ª–æ–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã —Å—é–¥–∞ ---
                    with st.expander(f"üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({len(task.comments)})"):
                        for comment in task.comments:
                            st.markdown(f"**{comment.author}:** {comment.text}")
                        
                        comment_text = st.text_input("–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:", key=f"comment_{index}", label_visibility="collapsed", placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...")
                        if st.button("–û—Ç–ø—Ä–∞–≤–∏—Ç—å", key=f"send_comment_{index}"):
                            if comment_text:
                                # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∞–≤—Ç–æ—Ä–∞ –Ω—É–∂–Ω–æ –±—Ä–∞—Ç—å –∏–∑ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                author_name = "–Ø" 
                                new_comment = Comment(author=author_name, text=comment_text)
                                st.session_state.tasks[index].comments.append(new_comment) # –û—à–∏–±–∫–∞ –∑–¥–µ—Å—å, –∏—Å–ø—Ä–∞–≤–∏–º
                                st.rerun()

                    with st.expander(f"üìé –§–∞–π–ª—ã ({len(task.attachments)})", expanded=False):
                        for att_index, attachment in enumerate(task.attachments):
                            st.download_button(
                                label=f"üìÑ {attachment.file_name}",
                                data=attachment.file_data,
                                file_name=attachment.file_name,
                                key=f"download_{index}_{att_index}"
                            )
                        
                        uploaded_files = st.file_uploader("–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã", accept_multiple_files=True, key=f"uploader_{index}", label_visibility="collapsed")
                        if uploaded_files:
                            for uploaded_file in uploaded_files:
                                new_attachment = Attachment(file_name=uploaded_file.name, file_data=uploaded_file.getvalue())
                                st.session_state.tasks[index].attachments.append(new_attachment)
                            st.rerun()
                    # --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---

                    if task.status == "To Do":
                        if st.button("–í —Ä–∞–±–æ—Ç—É ‚Üí", key=f"move_{index}"):
                            st.session_state.tasks[index].status = "In Progress"
                            st.rerun()
                    elif task.status == "In Progress":
                        if st.button("‚úì –ó–∞–≤–µ—Ä—à–∏—Ç—å", key=f"move_{index}"):
                            st.session_state.tasks[index].status = "Done"
                            st.rerun()

                    if st.session_state.editing_task_index == index:
                        new_description = st.text_area("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å:", value=task.description, key=f"edit_area_{index}")
                        if st.button("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", key=f"save_{index}"):
                            st.session_state.tasks[index].description = new_description
                            st.session_state.editing_task_index = None
                            st.rerun()

                    else:
                        col_desc, col_actions = st.columns([3, 1])
                        with col_desc: st.markdown(f"> {task.description}")
                        
                        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ–¥–ª–∞–π–Ω–∞
                        today = date.today()
                        if task.deadline:
                            delta = (task.deadline - today).days
                            if delta < 0 and task.status != "Done":
                                st.caption(f"üî• –î–µ–¥–ª–∞–π–Ω: {task.deadline.strftime('%d.%m.%Y')} (–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ {-delta} –¥.)")
                            else:
                                st.caption(f"üóìÔ∏è –î–µ–¥–ª–∞–π–Ω: {task.deadline.strftime('%d.%m.%Y')}")


                        with col_actions:
                            # –í—ã–±–æ—Ä –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ
                            responsible = st.selectbox("–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π", responsibles, key=f"responsible_{index}", index=responsibles.index(task.responsible) if task.responsible in responsibles else 0)
                            st.session_state.tasks[index].responsible = responsible


                            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ–¥–ª–∞–π–Ω–∞
                            priorities = ["–ù–∏–∑–∫–∏–π", "–°—Ä–µ–¥–Ω–∏–π", "–í—ã—Å–æ–∫–∏–π"]
                            new_deadline = st.date_input("–î–µ–¥–ª–∞–π–Ω", value=task.deadline, key=f"deadline_{index}")
                            st.session_state.tasks[index].deadline = new_deadline
                            if st.button("‚úèÔ∏è", key=f"edit_{index}"):
                                st.session_state.editing_task_index = index
                                st.rerun()
                            if st.button("üóëÔ∏è", key=f"delete_{index}"):
                                del st.session_state.tasks[index]
                                st.rerun()
                todo_col, in_progress_col, done_col = st.columns(3) 
                
                with todo_col:
                    st.subheader("To Do") 
                    for i, task in enumerate(st.session_state.tasks):
                        if task.status == "To Do": 
                            with st.container(border=True):
                                display_task(task, i)
                with in_progress_col:
                    st.subheader("In Progress")
                    for i, task in enumerate(st.session_state.tasks):
                        if task.status == "In Progress": display_task(task, i)
                with done_col:
                    st.subheader("Done")
                    for i, task in enumerate(st.session_state.tasks):
                        if task.status == "Done": 
                            with st.container(border=True):
                                st.markdown(f"‚úÖ ~~_{task.description}_~~")
                
                # --- –ù–û–í–´–ô –ë–õ–û–ö: –≠–ö–°–ü–û–†–¢ –í CSV ---
                st.markdown("---")
                st.subheader("–≠–∫—Å–ø–æ—Ä—Ç –ü–ª–∞–Ω–∞")
                
                try:
                    import pandas as pd
                    
                    tasks_data = [{
                        "–ó–∞–¥–∞—á–∞": task.description,
                        "–°—Ç–∞—Ç—É—Å": task.status,
                        "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π": task.responsible,
                        "–î–µ–¥–ª–∞–π–Ω": task.deadline.strftime('%Y-%m-%d') if task.deadline else ""
                    } for task in st.session_state.tasks]
                    
                    df = pd.DataFrame(tasks_data)
                    csv = df.to_csv(index=False).encode('utf-8')
                    
                    st.download_button("üì• –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ü–ª–∞–Ω –≤ CSV", csv, "corepath_project_plan.csv", "text/csv")
                except ImportError:
                    st.warning("–î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ CSV –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É pandas: `pip install pandas`")

        with tab5: # –ö–∞–ø–∏—Ç–∞–ª
            st.subheader("–ö–∞–ø–∏—Ç–∞–ª –í–ª–∏—è–Ω–∏—è")
            with st.expander("‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∞–∫—Ç–∏–≤ –≤–ª–∏—è–Ω–∏—è"):
                with st.form("influence_asset_form", clear_on_submit=True):
                    asset_type = st.selectbox("–¢–∏–ø –∞–∫—Ç–∏–≤–∞", ["–û—Ç–∑—ã–≤", "–ö–µ–π—Å", "–£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ –°–ú–ò", "–í—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ"])
                    asset_title = st.text_input("–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞–∫—Ç–∏–≤–∞", placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '–û—Ç–∑—ã–≤ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ X –æ –∫—É—Ä—Å–µ'")
                    uploaded_image = st.file_uploader("–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)", type=["png", "jpg", "jpeg"])
                    asset_description = st.text_area("–û–ø–∏—Å–∞–Ω–∏–µ / –¢–µ–∫—Å—Ç –∞–∫—Ç–∏–≤–∞", placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞, –æ–ø–∏—Å–∞–Ω–∏–µ –∫–µ–π—Å–∞ –∏–ª–∏ —Å—Å—ã–ª–∫—É –Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—é.")
                    asset_submitted = st.form_submit_button("–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞–ø–∏—Ç–∞–ª")
                    if asset_submitted:
                        if asset_title and asset_description:
                            image_data = None
                            if uploaded_image is not None:
                                image_data = uploaded_image.getvalue()
                            
                            new_asset = InfluenceAsset(title=asset_title, asset_type=asset_type, description=asset_description, image_bytes=image_data)
                            st.session_state.client_profile.influence_capital.append(new_asset)
                            st.success(f"–ê–∫—Ç–∏–≤ ¬´{asset_title}¬ª —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!")
                        else:
                            st.error("–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∞ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏.")

            st.subheader("üíº –ü–æ—Ä—Ç—Ñ–µ–ª—å –∞–∫—Ç–∏–≤–æ–≤")
            if st.session_state.client_profile.influence_capital:
                for asset in reversed(st.session_state.client_profile.influence_capital):
                    with st.container(border=True):
                        st.markdown(f"**{asset.title}**")
                        if asset.image_bytes:
                            st.image(asset.image_bytes, width=300)
                        st.caption(f"–¢–∏–ø: {asset.asset_type}")
                        st.write(asset.description)
            else:
                st.info("–í –≤–∞—à–µ–º –ø–æ—Ä—Ç—Ñ–µ–ª–µ –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º—É –≤—ã—à–µ.")

        with tab6: # –ö–æ–º–∞–Ω–¥–∞
            st.subheader("–ö–æ–º–∞–Ω–¥–Ω—ã–π –ú–æ–¥—É–ª—å")

            with st.expander("‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ —á–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥—ã"):
                with st.form("team_member_form", clear_on_submit=True):
                    member_name = st.text_input("–ò–º—è —á–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥—ã")
                    member_role = st.text_input("–†–æ–ª—å –≤ –ø—Ä–æ–µ–∫—Ç–µ", placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—Ü–µ–Ω–∞—Ä–∏—Å—Ç, –ú–æ–Ω—Ç–∞–∂–µ—Ä")
                    
                    member_submitted = st.form_submit_button("–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–º–∞–Ω–¥—É")
                    if member_submitted:
                        if member_name and member_role:
                            new_member = TeamMember(name=member_name, role=member_role)
                            st.session_state.client_profile.team.append(new_member)
                            st.success(f"–£—á–∞—Å—Ç–Ω–∏–∫ ¬´{member_name}¬ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–º–∞–Ω–¥—É!")
                            st.rerun()
                        else:
                            st.error("–ò–º—è –∏ —Ä–æ–ª—å –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏.")
            
            st.subheader("–°–æ—Å—Ç–∞–≤ –∫–æ–º–∞–Ω–¥—ã")
            if st.session_state.client_profile.team:
                for i, member in enumerate(st.session_state.client_profile.team):
                    col_name, col_role, col_action = st.columns([2, 2, 1])
                    col_name.write(member.name)
                    col_role.write(member.role)
                    if col_action.button("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å", key=f"del_member_{i}"):
                        st.session_state.client_profile.team.pop(i)
                        st.rerun()
            else:
                st.info("–í –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥–µ –ø–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.")

from dataclasses import dataclass, field, asdict
from typing import List, Dict, Any, Optional
from uuid import UUID, uuid4
import google.generativeai as genai
import json
from datetime import date

# ==============================================================================
# --- –ë–õ–û–ö 1: –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –°–¢–†–£–ö–¢–£–† –î–ê–ù–ù–´–• ---
# ==============================================================================

@dataclass
class ClientProfileHub:
    """
    –ö–ª–∞—Å—Å –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–∏–π "–ï–¥–∏–Ω—ã–π –ò—Å—Ç–æ—á–Ω–∏–∫ –ü—Ä–∞–≤–¥—ã" (Client_Profile_Hub)
    —Å–æ–≥–ª–∞—Å–Ω–æ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –ó–∞–¥–∞–Ω–∏—é v8.1.
    """
    client_id: UUID = field(default_factory=uuid4)
    brand_name: Optional[str] = None
    niche: List[str] = field(default_factory=list)
    superpower: Optional[str] = None
    gz: List[Dict[str, Any]] = field(default_factory=list)
    strategic_goals: Dict[str, Any] = field(default_factory=dict)
    audience_groups: Dict[str, Any] = field(default_factory=dict)
    positioning_matrix: Dict[str, Any] = field(default_factory=dict)
    positioning_synth: Optional[str] = None
    values: List[str] = field(default_factory=list)
    enemies: List[str] = field(default_factory=list)
    style_voice: Dict[str, Any] = field(default_factory=dict)
    products: List[Dict[str, Any]] = field(default_factory=list)
    harmony_report: Optional[Dict[str, Any]] = None
    show_pitch: Optional[Dict[str, Any]] = None
    formats: List[Dict[str, Any]] = field(default_factory=list)
    regalia_ref: Optional[UUID] = None
    influence_capital: List['InfluenceAsset'] = field(default_factory=list)
    team: List['TeamMember'] = field(default_factory=list)

@dataclass
class InfluenceAsset:
    """
    –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –æ–¥–∏–Ω –∞–∫—Ç–∏–≤ –≤ "–ö–∞–ø–∏—Ç–∞–ª–µ –í–ª–∏—è–Ω–∏—è" (–§–∞–∑–∞ I).
    """
    title: str
    asset_type: str  # "–û—Ç–∑—ã–≤", "–ö–µ–π—Å", "–£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ –°–ú–ò", "–í—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ"
    description: str
    image_bytes: Optional[bytes] = None
    asset_id: UUID = field(default_factory=uuid4)

@dataclass
class TeamMember:
    """
    –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –æ–¥–Ω–æ–≥–æ —á–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥—ã.
    """
    name: str
    role: str
    member_id: UUID = field(default_factory=uuid4)

@dataclass
class Comment:
    """
    –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –æ–¥–∏–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–¥–∞—á–µ.
    """
    author: str
    text: str
    comment_id: UUID = field(default_factory=uuid4)

@dataclass
class Attachment:
    """
    –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –æ–¥–∏–Ω –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –∫ –∑–∞–¥–∞—á–µ.
    """
    file_name: str
    file_data: bytes
    attachment_id: UUID = field(default_factory=uuid4)

@dataclass
class Product:
    """
    –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –æ–¥–∏–Ω –ø—Ä–æ–¥—É–∫—Ç –≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤–æ–π –ª–∏–Ω–µ–π–∫–µ –∫–ª–∏–µ–Ω—Ç–∞.
    """
    name: str
    price: float
    purpose: str

@dataclass
class ProductValueLadder:
    """
    –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç "–õ–µ—Å—Ç–Ω–∏—Ü—É –¶–µ–Ω–Ω–æ—Å—Ç–∏ –ü—Ä–æ–¥—É–∫—Ç–∞" (PVL) –∏–∑ –¢–ó 5.3.1.
    """
    lead_magnet: Optional[Product] = None
    tripwire: Optional[Product] = None
    core_offer: Optional[Product] = None
    high_ticket: Optional[Product] = None

@dataclass
class Task:
    """
    –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –æ–¥–Ω—É –∑–∞–¥–∞—á—É –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞.
    """
    description: str
    status: str = "To Do"
    responsible: Optional[str] = ""
    priority: str = "–°—Ä–µ–¥–Ω–∏–π"  # –ù–∏–∑–∫–∏–π, –°—Ä–µ–¥–Ω–∏–π, –í—ã—Å–æ–∫–∏–π
    deadline: Optional[date] = None
    comments: List[Comment] = field(default_factory=list)
    attachments: List[Attachment] = field(default_factory=list)

# ==============================================================================
# --- –ë–õ–û–ö 1.5: –î–ê–ù–ù–´–ï –î–õ–Ø –ö–û–ù–°–¢–†–£–ö–¢–û–†–ê "8 –û–ü–û–†–ù–´–• –¢–û–ß–ï–ö" ---
# ==============================================================================

ANCHOR_POINTS_DATA = {
    "content_carriers": [
        "–ü–æ—Å—Ç —Å —Ñ–æ—Ç–æ", "–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –¥–ª–∏–Ω–Ω–æ–µ –≤–∏–¥–µ–æ", "–°—Ç–æ—Ä–∏—Ç–µ–π–ª–∏–Ω–≥", 
        "–ü—Ä—è–º–æ–π —ç—Ñ–∏—Ä", "–®–æ—Ä—Ç—Å", "–ü—É–±–ª–∏—á–Ω–æ–µ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ", "–°—Ç–∞—Ç—å—è", 
        "–ê—É–¥–∏–æ-–ø–æ—Å—Ç", "–ü–æ–¥–∫–∞—Å—Ç"
    ],
    "formats": [
        "–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π", "–†–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π", "–ü—Ä–æ–¥–∞—é—â–∏–π", "–õ–∏—á–Ω—ã–π", "–ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–π"
    ],
    "blog_genres": [
        "–û–±–∑–æ—Ä", "–†–∞—Å–ø–∞–∫–æ–≤–∫–∞", "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ", "–¢–æ–ø—ã / –†–µ–π—Ç–∏–Ω–≥–∏", "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ / –†–∞–∑–±–æ—Ä",
        "–ö—Ä–∏—Ç–∏–∫–∞ / –•–µ–π—Ç–∏–Ω–≥", "–°–∫–µ—Ç—á / –°—Ü–µ–Ω–∫–∞", "–ü—Ä–∞–Ω–∫", "–ß–µ–ª–ª–µ–Ω–¥–∂ / –í—ã–∑–æ–≤",
        "–†–µ–∞–∫—Ü–∏—è", "–õ–µ—Ç—Å–ø–ª–µ–π / –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ", "–ò–Ω—Ç–µ—Ä–≤—å—é", "–ì–∞–π–¥ / –¢—É—Ç–æ—Ä–∏–∞–ª",
        "DIY (–°–¥–µ–ª–∞–π —Å–∞–º)", "–ù–∞—É—á–ø–æ–ø / –û–±—ä—è—Å–Ω–µ–Ω–∏–µ", "–í–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç (Q&A)",
        "–í–ª–æ–≥", "–ú–æ–π –¥–µ–Ω—å / –†—É—Ç–∏–Ω–∞", "–¢—Ä–µ–≤–µ–ª-–≤–∏–¥–µ–æ", "–ë—ç–∫—Å—Ç–µ–π–¥–∂ / –ó–∞–∫—É–ª–∏—Å—å–µ",
        "–°—Ç–æ—Ä–∏—Ç–µ–ª–ª–∏–Ω–≥ / –ò—Å—Ç–æ—Ä–∏—è –∏–∑ –∂–∏–∑–Ω–∏", "–ú–Ω–µ–Ω–∏–µ / –ú–æ–Ω–æ–ª–æ–≥"
    ],
    "extras_triggers": [
        "–ö–æ–Ω–∫—É—Ä—Å/–†–æ–∑—ã–≥—Ä—ã—à", "–¢–µ—Å—Ç/–í–∏–∫—Ç–æ—Ä–∏–Ω–∞", "–ó–∞–≥–∞–¥–∫–∞/–ì–æ–ª–æ–≤–æ–ª–æ–º–∫–∞", "–û–ø—Ä–æ—Å/–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ",
        "–ú–µ–º—ã", "–í—Ä–µ–¥–Ω—ã–µ —Å–æ–≤–µ—Ç—ã", "–ö–µ–π—Å/–ü—Ä–∏–º–µ—Ä", "–†–∞–∑–±–æ—Ä –æ—à–∏–±–æ–∫", "–î–∞–Ω–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π",
        "–ò—Å—Ç–æ—Ä–∏—è –∏–∑ –∂–∏–∑–Ω–∏", "–ë–µ–∫—Å—Ç–µ–π–¥–∂/–ó–∞–∫—É–ª–∏—Å—å–µ", "–î–æ –∏ –ø–æ—Å–ª–µ", "–§–ª–µ—à–±–µ–∫/–ù–æ—Å—Ç–∞–ª—å–≥–∏—è",
        "–û—Ç–∫—Ä–æ–≤–µ–Ω–∏–µ/–ü—Ä–∏–∑–Ω–∞–Ω–∏–µ", "–°–∫—Ä–∏–Ω—ã –ø–µ—Ä–µ–ø–∏—Å–∫–∏", "–ü—Ä–æ–≤–æ–∫–∞—Ü–∏—è", "–®–æ–∫-–∫–æ–Ω—Ç–µ–Ω—Ç",
        "–ú–∏–ª–æ—Ç–∞", "–≠—Å—Ç–µ—Ç–∏–∫–∞", "–û—Ç–≤–µ—Ç –Ω–∞ —Ö–µ–π—Ç", "–°–∞—Å–ø–µ–Ω—Å/–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ", "ASMR/Satisfying",
        "–°–æ—Ü. –¥–æ–∫-–≤–æ", "–ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç", "–î–µ–¥–ª–∞–π–Ω", "–î–µ—Ñ–∏—Ü–∏—Ç", "–ò–Ω—Ç—Ä–∏–≥–∞", "–¢–∏–∑–µ—Ä—ã"
    ],
    "movie_genres": [
        "–ö–æ–º–µ–¥–∏—è", "–ë–æ–µ–≤–∏–∫", "–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è", "–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞", "–î—Ä–∞–º–∞ / –ú–µ–ª–æ–¥—Ä–∞–º–∞",
        "–¢—Ä–∏–ª–ª–µ—Ä / –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π", "–•–æ—Ä—Ä–æ—Ä / –£–∂–∞—Å—ã", "–§—ç–Ω—Ç–µ–∑–∏", "–î–µ—Ç–µ–∫—Ç–∏–≤",
        "–î–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å–º", "–§–∏–ª—å–º-–∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞", "–ú—é–∑–∏–∫–ª", "–°–∫–∞–∑–∫–∞"
    ],
    "tv_genres": [
        "–¢–æ–∫-—à–æ—É", "–†–µ–∞–ª–∏—Ç–∏-—à–æ—É", "–ò–≥—Ä–æ–≤–æ–µ —à–æ—É", "–®–æ—É —Ç–∞–ª–∞–Ω—Ç–æ–≤",
        "–®–æ—É –æ –ø—Ä–µ–æ–±—Ä–∞–∂–µ–Ω–∏–∏", "–î–µ–±–∞—Ç—ã", "–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞", "–†–µ–ø–æ—Ä—Ç–∞–∂",
        "–í–µ—á–µ—Ä–Ω–µ–µ —à–æ—É", "–°–µ—Ä–∏–∞–ª", "–°–∏—Ç–∫–æ–º"
    ]
}

# ==============================================================================
# --- –ë–õ–û–ö 2: –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –î–í–ò–ñ–ö–û–í –°–ò–°–¢–ï–ú–´ (—Å –º–æ–∫-–¥–∞–Ω–Ω—ã–º–∏) ---
# ==============================================================================

class IngestionEngine:
    """–†–µ–∞–ª–∏–∑—É–µ—Ç "–î–≤–∏–∂–æ–∫ –ü–æ–≥–ª–æ—â–µ–Ω–∏—è" (–®–∞–≥ 1, –§–∞–∑–∞ F)."""
    def __init__(self, api_key: Optional[str] = None):
        self.api_key = api_key
        if api_key:
            genai.configure(api_key=api_key)
            
    def _get_mock_profile(self) -> ClientProfileHub:
        print("‚ö†Ô∏è API-–∫–ª—é—á –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å.")
        return ClientProfileHub(
            brand_name="–í–∞–ª–µ–Ω—Ç–∏–Ω –§–æ–∫–∏–Ω (–ú–æ–∫)",
            niche=["–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥", "–ü—Ä–æ–¥—é—Å–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤"],
            superpower="–°–æ–∑–¥–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–π –∏ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ –∏—Ö –≤ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã.",
            gz=[{"goal": "–ó–∞–ø—É—Å—Ç–∏—Ç—å 5 –ø–∏–ª–æ—Ç–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤", "stress_reduction": 0.8}, {"goal": "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥", "stress_reduction": 0.6}],
            values=["–°–∏—Å—Ç–µ–º–Ω–æ—Å—Ç—å", "–ò–Ω–Ω–æ–≤–∞—Ü–∏–∏", "–ß–µ—Å—Ç–Ω–æ—Å—Ç—å", "–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ"],
            enemies=["–ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥", "–ò–Ω—Ñ–æ—Ü—ã–≥–∞–Ω—Å—Ç–≤–æ", "–í—ã–≥–æ—Ä–∞–Ω–∏–µ –æ—Ç —Ä—É—Ç–∏–Ω—ã"],
            style_voice={
                "tone_of_voice": "–ü—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–π / –ù–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å–∫–∏–π",
                "anchor_phrases": ["–†–∞–±–æ—Ç–∞–µ–º.", "–≠—Ç–æ –±–∞–∑–∞.", "–î—É–º–∞–π."],
                "forbidden_words": ["–∫–æ—Ä–æ—á–µ", "–∫–∞–∫ –±—ã"]
            }
        )

    def _call_llm_for_extraction(self, raw_text: str) -> Optional[ClientProfileHub]:
        if not self.api_key:
            return self._get_mock_profile() # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–∫-–¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –Ω–µ—Ç API-–∫–ª—é—á–∞

        print("\nü§ñ [Real AI] –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —á–µ—Ä–µ–∑ Gemini API...")
        prompt = f"""
        You are a strategic consultant. Your task is to analyze the provided text from a client's questionnaire and extract key information.
        The output MUST be a valid JSON object with the following structure:
        {{
          "brand_name": "string",
          "niche": ["string", ...],
          "superpower": "string",
          "gz": [{{"goal": "string", "stress_reduction": "float from 0.0 to 1.0"}}, ...],
          "values": ["string", ...],
          "enemies": ["string", ...],
          "style_voice": {{
            "tone_of_voice": "string",
            "anchor_phrases": ["string", ...],
            "forbidden_words": ["string", ...]
          }}
        }}
        Do not add any text or explanations before or after the JSON object.

        ---
        Questionnaire Text:
        "{raw_text}"
        ---
        """
        try:
            safety_settings = {
                'HARM_CATEGORY_HARASSMENT': 'BLOCK_ONLY_HIGH',
                'HARM_CATEGORY_HATE_SPEECH': 'BLOCK_ONLY_HIGH',
                'HARM_CATEGORY_SEXUALLY_EXPLICIT': 'BLOCK_ONLY_HIGH',
                'HARM_CATEGORY_DANGEROUS_CONTENT': 'BLOCK_ONLY_HIGH',
            }
            model = genai.GenerativeModel('gemini-pro-latest')
            response = model.generate_content(
                prompt,
                safety_settings=safety_settings)
            # –£–¥–∞–ª—è–µ–º "```json" –∏ "```" –∏–∑ –æ—Ç–≤–µ—Ç–∞ Gemini
            cleaned_response = response.text.strip().replace("```json", "").replace("```", "")
            extracted_data = json.loads(cleaned_response)
            return ClientProfileHub(**extracted_data)
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è —á–µ—Ä–µ–∑ API: {e}")
            return None

    def process(self, raw_text: str) -> Optional[ClientProfileHub]:
        print("üöÄ –ó–∞–ø—É—Å–∫ –î–≤–∏–∂–∫–∞ –ü–æ–≥–ª–æ—â–µ–Ω–∏—è...")
        profile = self._call_llm_for_extraction(raw_text)
        if profile:
            print("‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω!")
        return profile

class BlueOceanEngine:
    """–†–µ–∞–ª–∏–∑—É–µ—Ç "–î–≤–∏–∂–æ–∫ –ì–æ–ª—É–±–æ–≥–æ –û–∫–µ–∞–Ω–∞" (–®–∞–≥ 3, –§–∞–∑–∞ O)."""
    def __init__(self, api_key: Optional[str] = None):
        self.api_key = api_key
        if api_key:
            genai.configure(api_key=api_key)
            
    def _get_mock_matrix(self) -> Dict[str, List[str]]:
        print("‚ö†Ô∏è API-–∫–ª—é—á –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ú–∞—Ç—Ä–∏—Ü–∞ 4-—Ö –î–µ–π—Å—Ç–≤–∏–π.")
        return {
            "eliminate": ["–†—É—á–Ω–∞—è '—Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞' —ç–∫—Å–ø–µ—Ä—Ç–æ–≤", "–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –±–µ–∑ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏"],
            "reduce": ["–í—Ä–µ–º—è –Ω–∞ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –∫–ª–∏–µ–Ω—Ç–∞", "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç '–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è'"],
            "raise": ["–ì–ª—É–±–∏–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏", "–ö–æ–Ω—Ç–µ–∫—Å—Ç—É–∞–ª—å–Ω–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞"],
            "create": ["–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π '–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π –ú–†–¢-—Å–∫–∞–Ω–µ—Ä'", "–ï–¥–∏–Ω—ã–π 'Client_Profile_Hub'"]
        }

    def _call_llm_for_matrix(self, raw_text: str, client_profile: ClientProfileHub) -> Optional[Dict[str, List[str]]]:
        if not self.api_key:
            return self._get_mock_matrix()

        print("\nü§ñ [Real AI] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ú–∞—Ç—Ä–∏—Ü—ã 4-—Ö –î–µ–π—Å—Ç–≤–∏–π —á–µ—Ä–µ–∑ Gemini API...")
        prompt = f"""
        You are a Blue Ocean Strategy expert. Analyze the client's profile and the description of their competitors.
        Based on this, generate a 4-Actions-Framework matrix.
        The client's own information and the information about competitors are provided in a single text block. Your task is to distinguish between them.
        The output MUST be a valid JSON object with keys: "eliminate", "reduce", "raise", "create". Each key should have a list of strings as its value.
        Do not add any text or explanations before or after the JSON object.

        **Client Profile:**
        - Superpower: {client_profile.superpower}
        - Niche: {', '.join(client_profile.niche)}

        **Context (Client & Competitors):**
        "{raw_text}"
        """
        try:
            safety_settings = {
                'HARM_CATEGORY_HARASSMENT': 'BLOCK_ONLY_HIGH',
                'HARM_CATEGORY_HATE_SPEECH': 'BLOCK_ONLY_HIGH',
                'HARM_CATEGORY_SEXUALLY_EXPLICIT': 'BLOCK_ONLY_HIGH',
                'HARM_CATEGORY_DANGEROUS_CONTENT': 'BLOCK_ONLY_HIGH',
            }
            model = genai.GenerativeModel('gemini-pro-latest')
            response = model.generate_content(
                prompt,
                safety_settings=safety_settings)
            cleaned_response = response.text.strip().replace("```json", "").replace("```", "")
            return json.loads(cleaned_response)
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ú–∞—Ç—Ä–∏—Ü—ã 4-—Ö –î–µ–π—Å—Ç–≤–∏–π —á–µ—Ä–µ–∑ API: {e}")
            return None

    def process(self, raw_text: str, client_profile: ClientProfileHub) -> Optional[Dict[str, List[str]]]:
        print("üåä –ó–∞–ø—É—Å–∫ –î–≤–∏–∂–∫–∞ –ì–æ–ª—É–±–æ–≥–æ –û–∫–µ–∞–Ω–∞...")
        matrix = self._call_llm_for_matrix(raw_text, client_profile)
        if matrix:
            print("‚úÖ –ú–∞—Ç—Ä–∏—Ü–∞ 4-—Ö –î–µ–π—Å—Ç–≤–∏–π —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞!")
        return matrix

class StrategyEngine:
    """–†–µ–∞–ª–∏–∑—É–µ—Ç "–î–≤–∏–∂–æ–∫ –°—Ç—Ä–∞—Ç–µ–≥–∏–∏" (–®–∞–≥ 3, –§–∞–∑–∞ O)."""
    def __init__(self, api_key: Optional[str] = None):
        self.api_key = api_key
        if api_key:
            genai.configure(api_key=api_key)
            
    def _get_mock_roadmap(self) -> Dict[str, Any]:
        print("‚ö†Ô∏è API-–∫–ª—é—á –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Roadmap.")
        return {
            "roadmap": [
                {"step": 1, "title": "–§–∞–∑–∞ K: –£–ø–∞–∫–æ–≤–∫–∞", "description": "–°–æ–∑–¥–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å 3-5 –µ–¥–∏–Ω–∏—Ü –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—â–∏—Ö '—Å—É–ø–µ—Ä—Å–∏–ª—É'.", "target_groups": ["–ì1", "–ì2"]},
                {"step": 2, "title": "–§–∞–∑–∞ I: –°–±–æ—Ä –ö–∞–ø–∏—Ç–∞–ª–∞", "description": "–°–æ–±—Ä–∞—Ç—å –ø–µ—Ä–≤—ã–µ 5-10 –æ—Ç–∑—ã–≤–æ–≤ –∏ —É–ø–∞–∫–æ–≤–∞—Ç—å 1-2 –∫–µ–π—Å–∞.", "target_groups": ["–ì2"]},
                {"step": 3, "title": "–§–∞–∑–∞ O: –ù–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥", "description": "–ü—Ä–æ–≤–µ—Å—Ç–∏ 3 –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏–∏ —Å —ç–∫—Å–ø–µ—Ä—Ç–∞–º–∏ –∏–∑ —Å–º–µ–∂–Ω—ã—Ö –Ω–∏—à.", "target_groups": ["–ì3"]},
                {"step": 4, "title": "–§–∞–∑–∞ N: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ", "description": "–í—ã—Å—Ç—É–ø–∏—Ç—å –Ω–∞ 1-2 –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã—Ö –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è—Ö –∏–ª–∏ –±–∏–∑–Ω–µ—Å-–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö.", "target_groups": ["–ì4", "–ì5"]}
            ],
            "audience_groups": {
                "–ì1: –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞": "–ú–∞—Å—Å–æ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è, –ø–æ–¥–ø–∏—Å—á–∏–∫–∏. –¶–µ–ª—å: –æ—Ö–≤–∞—Ç –∏ –≤–æ–≤–ª–µ—á–µ–Ω–∏–µ.",
                "–ì2: –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤": "–ö–ª–∏–µ–Ω—Ç—ã, –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏. –¶–µ–ª—å: –ø—Ä—è–º–æ–π –¥–æ—Ö–æ–¥, —Å–±–æ—Ä –∫–µ–π—Å–æ–≤.",
                "–ì3: –ò–Ω—Ñ–ª—é–µ–Ω—Å–µ—Ä—ã / –≠–∫—Å–ø–µ—Ä—Ç—ã": "–ü–∞—Ä—Ç–Ω–µ—Ä—ã –ø–æ –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏—è–º. –¶–µ–ª—å: —Å–æ—Ü–∏–∞–ª—å–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª, –¥–æ—Å—Ç—É–ø –∫ –Ω–æ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏.",
                "–ì4: –ü–ª–æ—â–∞–¥–∫–∏ / –ö–æ–º–ø–∞–Ω–∏–∏": "–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—ã –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π, –±—Ä–µ–Ω–¥—ã. –¶–µ–ª—å: B2B-–ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–∞.",
                "–ì5: –õ–ü–† (–õ–∏—Ü–∞, –ü—Ä–∏–Ω–∏–º–∞—é—â–∏–µ –†–µ—à–µ–Ω–∏—è)": "–ò–Ω–≤–µ—Å—Ç–æ—Ä—ã, –∫–ª—é—á–µ–≤—ã–µ —Ñ–∏–≥—É—Ä—ã. –¶–µ–ª—å: –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –ì–ª–æ–±–∞–ª—å–Ω–æ–π –¶–µ–ª–∏."
            }
        }

    def _call_llm_for_roadmap(self, profile: ClientProfileHub) -> Optional[Dict[str, Any]]:
        if not self.api_key:
            return self._get_mock_roadmap()

        print("\nü§ñ [Real AI] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Roadmap –∏ 5 –ì—Ä—É–ø–ø –¶–ê —á–µ—Ä–µ–∑ Gemini API...")
        prompt = f"""
        You are a master strategist. Based on the client's profile, generate a strategic roadmap and define the 5 stakeholder groups.
        The output MUST be a valid JSON object with two keys: "roadmap" and "audience_groups".
        - "roadmap" should be a list of objects, each with "step", "title", "description", and "target_groups".
        - "audience_groups" should be an object with 5 keys (–ì1 to –ì5) and their descriptions.
        Do not add any text or explanations before or after the JSON object.

        **Client Profile:**
        - Brand Name: {profile.brand_name}
        - Superpower: {profile.superpower}
        - Global Goals (GZ): {', '.join([g['goal'] for g in profile.gz])}
        """
        try:
            safety_settings = {
                'HARM_CATEGORY_HARASSMENT': 'BLOCK_ONLY_HIGH',
                'HARM_CATEGORY_HATE_SPEECH': 'BLOCK_ONLY_HIGH',
                'HARM_CATEGORY_SEXUALLY_EXPLICIT': 'BLOCK_ONLY_HIGH',
                'HARM_CATEGORY_DANGEROUS_CONTENT': 'BLOCK_ONLY_HIGH',
            }
            model = genai.GenerativeModel('gemini-pro-latest')
            response = model.generate_content(
                prompt,
                safety_settings=safety_settings)
            cleaned_response = response.text.strip().replace("```json", "").replace("```", "")
            return json.loads(cleaned_response)
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Roadmap —á–µ—Ä–µ–∑ API: {e}")
            return None

    def process(self, profile: ClientProfileHub) -> Optional[Dict[str, Any]]:
        print("üó∫Ô∏è –ó–∞–ø—É—Å–∫ –î–≤–∏–∂–∫–∞ –°—Ç—Ä–∞—Ç–µ–≥–∏–∏...")
        strategy_data = self._call_llm_for_roadmap(profile)
        if strategy_data:
            print("‚úÖ Roadmap –∏ 5 –ì—Ä—É–ø–ø –¶–ê —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã!")
        return strategy_data

class HarmonyDiagnosticEngine:
    """–†–µ–∞–ª–∏–∑—É–µ—Ç "–î–≤–∏–∂–æ–∫ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ì–∞—Ä–º–æ–Ω–∏–∏" (–®–∞–≥–∏ 5-6, –§–∞–∑–∞ K)."""
    # –≠—Ç–æ—Ç –¥–≤–∏–∂–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∞–≤–∏–ª, –∞ –Ω–µ LLM, –ø–æ—ç—Ç–æ–º—É API-–∫–ª—é—á –µ–º—É –Ω–µ –Ω—É–∂–µ–Ω.
    
    def process(self, profile: ClientProfileHub) -> ClientProfileHub:
        print("üßò –ó–∞–ø—É—Å–∫ –î–≤–∏–∂–∫–∞ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ì–∞—Ä–º–æ–Ω–∏–∏...")
        
        # --- –£–õ–£–ß–®–ï–ù–ò–ï: –õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ "–ö–æ–Ω—Ñ–ª–∏–∫—Ç–∞ F.O.K.I.N." ---
        conflicting_goal = None
        non_conflicting_goal = None
        enemy_triggers = []

        # 1. –ò—â–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ —Ü–µ–ª–∏ (—Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º —É—Å–ª—É–≥) –∏ –≤—Ä–∞–≥–æ–≤
        service_keywords = ["–∫–ª–∏–µ–Ω—Ç", "–ø—Ä–æ–¥—é—Å–∏—Ä–æ–≤–∞–Ω–∏–µ", "–º–µ–Ω—Ç–æ—Ä—Å—Ç–≤–æ", "–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏", "—É—Å–ª—É–≥–∏"]
        product_keywords = ["–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", "—Å–µ—Ä–≤–∏—Å", "–ø—Ä–æ–¥—É–∫—Ç", "–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å", "–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞"]
        enemy_keywords = ["–æ–¥–∏–Ω–æ—á–∫–∞", "–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å", "–≤—ã–≥–æ—Ä–∞–Ω–∏–µ", "—Ä—É—Ç–∏–Ω", "–≤–ø—Ä–∏—Ç—ã–∫"]

        for goal in profile.gz:
            goal_desc = goal.get("goal", "").lower()
            if any(kw in goal_desc for kw in service_keywords):
                conflicting_goal = goal
            elif any(kw in goal_desc for kw in product_keywords):
                non_conflicting_goal = goal

        for enemy in profile.enemies:
            if any(kw in enemy.lower() for kw in enemy_keywords):
                enemy_triggers.append(enemy)
        
        # 2. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç (—Ü–µ–ª—å-—É—Å–ª—É–≥–∞ + –≤—Ä–∞–≥-—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ) –∏ –µ—Å—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Ü–µ–ª—å-–ø—Ä–æ–¥—É–∫—Ç
        if conflicting_goal and enemy_triggers and non_conflicting_goal:
            print(f"‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω –ö–ª—é—á–µ–≤–æ–π –ö–æ–Ω—Ñ–ª–∏–∫—Ç! –¶–µ–ª—å '{conflicting_goal['goal']}' vs –í—Ä–∞–≥–∏ '{', '.join(enemy_triggers)}'")
            
            # 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º "–°—Ç—Ä–∞—Ç–µ–≥–∏—é –ë–∞–ª–∞–Ω—Å–∞"
            report_text = (
                f"**–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –û–±–Ω–∞—Ä—É–∂–µ–Ω –ö–ª—é—á–µ–≤–æ–π –ö–æ–Ω—Ñ–ª–∏–∫—Ç.**\n\n"
                f"–í–∞—à–∞ —Ü–µ–ª—å **¬´{conflicting_goal['goal']}¬ª** –Ω–∞–ø—Ä—è–º—É—é –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å –≤–∞—à–∏–º–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞–º–∏: *¬´{', '.join(enemy_triggers)}¬ª*.\n\n"
                f"**–†–ò–°–ö:** –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä—è–º–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å–ª—É–≥ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –Ω–µ–∏–∑–±–µ–∂–Ω–æ–º—É –≤—ã–≥–æ—Ä–∞–Ω–∏—é, —Å–∞–±–æ—Ç–∞–∂—É –∏ –ø–æ—Ç–µ—Ä–µ –º–æ—Ç–∏–≤–∞—Ü–∏–∏, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç –≤–∞—à–µ–π –ø—Ä–∏—Ä–æ–¥–µ '–∏–≥—Ä–æ–∫–∞-–æ–¥–∏–Ω–æ—á–∫–∏' –∏ –Ω–µ–∂–µ–ª–∞–Ω–∏—é —É–ø—Ä–∞–≤–ª—è—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤.\n\n"
                f"**–°–¢–†–ê–¢–ï–ì–ò–Ø –ë–ê–õ–ê–ù–°–ê (v2.0):**\n"
                f"1. **–°–º–µ–Ω–∞ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞:** –í–∞—à–∞ –∏—Å—Ç–∏–Ω–Ω–∞—è —Ü–µ–ª—å ‚Äî –Ω–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ª—É–≥, –∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è **¬´{non_conflicting_goal['goal']}¬ª**. \n"
                f"2. **–¶–µ–ª—å –∫–∞–∫ –†–µ—Å—É—Ä—Å:** –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ —Ü–µ–ª—å ¬´{conflicting_goal['goal']}¬ª –Ω–µ –∫–∞–∫ –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É, –∞ –∫–∞–∫ **–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ—Å—É—Ä—Å (—Ç–æ–ø–ª–∏–≤–æ)** –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∑–∞–ø—É—Å–∫–∞ –≤–∞—à–µ–≥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî ¬´{non_conflicting_goal['goal']}¬ª."
            )
            profile.harmony_report = {"report_text": report_text, "conflict_details": {"conflicting_goal": conflicting_goal, "non_conflicting_goal": non_conflicting_goal, "triggers": enemy_triggers}}
            print("‚úÖ –û—Ç—á–µ—Ç –æ –ì–∞—Ä–º–æ–Ω–∏–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!")
        else:
            # –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞, –µ—Å–ª–∏ —Å–ª–æ–∂–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
            profile.harmony_report = {"report_text": "**–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê:** –ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∞."}
            print("‚úÖ –ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∞.")
        return profile

class CommerceEngine:
    """–†–µ–∞–ª–∏–∑—É–µ—Ç –ú–æ–¥—É–ª—å –ö–æ–º–º–µ—Ä—Ü–∏–∏ "–ü–¢–£" (–ß–∞—Å—Ç—å V)."""
    def __init__(self, api_key: Optional[str] = None):
        self.api_key = api_key
        if api_key:
            genai.configure(api_key=api_key)
            
    def _get_mock_pvl(self) -> ProductValueLadder:
        print("‚ö†Ô∏è API-–∫–ª—é—á –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –õ–µ—Å—Ç–Ω–∏—Ü–∞ –¶–µ–Ω–Ω–æ—Å—Ç–∏.")
        return ProductValueLadder(
            lead_magnet=Product(name="–ß–µ–∫-–ª–∏—Å—Ç '5 –≥—Ä–µ—Ö–æ–≤ –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ' (–ú–æ–∫)", price=0, purpose="–°–±–æ—Ä –õ–∏–¥–æ–≤"),
            tripwire=Product(name="–ú–∏–Ω–∏-–∫—É—Ä—Å '–°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞' (–ú–æ–∫)", price=49, purpose="–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –ü–æ–∫—É–ø–∞—Ç–µ–ª—è"),
            core_offer=Product(name="–ö—É—Ä—Å 'CorePath OS' (–ú–æ–∫)", price=1990, purpose="–û—Å–Ω–æ–≤–Ω–∞—è –ü—Ä–∏–±—ã–ª—å"),
            high_ticket=Product(name="–ú–µ–Ω—Ç–æ—Ä—Å—Ç–≤–æ '–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ù–∞—Å–ª–µ–¥–∏—è' (–ú–æ–∫)", price=15000, purpose="–ú–∞–∫—Å–∏–º–∏–∑–∞—Ü–∏—è LTV")
        )

    def _call_llm_for_pvl_design(self, profile: ClientProfileHub) -> Optional[ProductValueLadder]:
        if not self.api_key:
            return self._get_mock_pvl()

        print("\nü§ñ [Real AI] –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –õ–µ—Å—Ç–Ω–∏—Ü—ã –¶–µ–Ω–Ω–æ—Å—Ç–∏ –ü—Ä–æ–¥—É–∫—Ç–∞ —á–µ—Ä–µ–∑ Gemini API...")
        prompt = f"""
        You are a product marketing expert. Based on the client's profile, design a Product Value Ladder (PVL).
        The output MUST be a valid JSON object with keys: "lead_magnet", "tripwire", "core_offer", "high_ticket".
        Each key should have an object with "name", "price" (float), and "purpose" as its value.
        Do not add any text or explanations before or after the JSON object.

        **Client Profile:**
        - Brand Name: {profile.brand_name}
        - Superpower: {profile.superpower}
        - Niche: {', '.join(profile.niche)}
        - Enemies (what they fight against): {', '.join(profile.enemies)}
        """
        try:
            safety_settings = {
                'HARM_CATEGORY_HARASSMENT': 'BLOCK_ONLY_HIGH',
                'HARM_CATEGORY_HATE_SPEECH': 'BLOCK_ONLY_HIGH',
                'HARM_CATEGORY_SEXUALLY_EXPLICIT': 'BLOCK_ONLY_HIGH',
                'HARM_CATEGORY_DANGEROUS_CONTENT': 'BLOCK_ONLY_HIGH',
            }
            model = genai.GenerativeModel('gemini-pro-latest')
            response = model.generate_content(
                prompt,
                safety_settings=safety_settings)
            cleaned_response = response.text.strip().replace("```json", "").replace("```", "")
            pvl_data = json.loads(cleaned_response)
            
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º JSON –≤ –Ω–∞—à–∏ –æ–±—ä–µ–∫—Ç—ã Product –∏ ProductValueLadder
            pvl = ProductValueLadder(
                lead_magnet=Product(**pvl_data['lead_magnet']) if 'lead_magnet' in pvl_data else None,
                tripwire=Product(**pvl_data['tripwire']) if 'tripwire' in pvl_data else None,
                core_offer=Product(**pvl_data['core_offer']) if 'core_offer' in pvl_data else None,
                high_ticket=Product(**pvl_data['high_ticket']) if 'high_ticket' in pvl_data else None,
            )
            return pvl
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ PVL —á–µ—Ä–µ–∑ API: {e}")
            return None

    def process(self, profile: ClientProfileHub) -> Optional[ProductValueLadder]:
        print("üí∞ –ó–∞–ø—É—Å–∫ –î–≤–∏–∂–∫–∞ –ö–æ–º–º–µ—Ä—Ü–∏–∏ (–ü–¢–£)...")
        pvl = self._call_llm_for_pvl_design(profile)
        if pvl:
            print("‚úÖ '–õ–µ—Å—Ç–Ω–∏—Ü–∞ –¶–µ–Ω–Ω–æ—Å—Ç–∏ –ü—Ä–æ–¥—É–∫—Ç–∞' —É—Å–ø–µ—à–Ω–æ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞!")
        return pvl

class AIScenarioProducer:
    """–†–µ–∞–ª–∏–∑—É–µ—Ç "AI-–°—Ü–µ–Ω–∞—Ä–Ω—ã–π –ü—Ä–æ–¥—é—Å–µ—Ä" (–ß–∞—Å—Ç—å IV)."""
    def __init__(self, api_key: Optional[str] = None):
        self.api_key = api_key
        if api_key:
            genai.configure(api_key=api_key)
            
    def _get_mock_script(self, profile: ClientProfileHub, product: Optional[Product] = None) -> Dict[str, str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–æ–∫–æ–≤—ã–π (—Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π) —Å—Ü–µ–Ω–∞—Ä–∏–π, –µ—Å–ª–∏ API –∫–ª—é—á –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω."""
        print("‚ö†Ô∏è API-–∫–ª—é—á –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π.")
        product_context = ""
        if product:
            product_context = f"""
        - Product to Promote:
          - Name: {product.name}
          - Price: ${product.price}
          - Purpose: {product.purpose}"""
        
        cta = f"–£—Å—Ç–∞–ª–∏ –æ—Ç –∏–Ω—Ñ–æ—Ü—ã–≥–∞–Ω—Å—Ç–≤–∞? –ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å, –∑–¥–µ—Å—å –ø—Ä–æ —Å–∏—Å—Ç–µ–º—É."
        if product:
            cta = f"–ì–æ—Ç–æ–≤—ã —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–≤—ã–π —à–∞–≥ –∫ —Å–∏—Å—Ç–µ–º–µ? –ó–∞–±–∏—Ä–∞–π—Ç–µ '{product.name}' –ø–æ —Å—Å—ã–ª–∫–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ –≤—Å–µ–≥–æ –∑–∞ ${product.price}!"

        anchor_phrase_list = profile.style_voice.get('anchor_phrases', [])
        anchor_phrase = anchor_phrase_list[0] if anchor_phrase_list else ""

        return {
            "title": "–°–∏—Å—Ç–µ–º–Ω—ã–π –ù–æ–∫–∞—É—Ç (–ú–æ–∫)",
            "shock": "*–†–µ–∑–∫–∏–π –∑–≤—É–∫ —Ä–≤—É—â–µ–π—Å—è –±—É–º–∞–≥–∏. –ù–∞ —ç–∫—Ä–∞–Ω–µ —Ä–≤–µ—Ç—Å—è –¥–∏–ø–ª–æ–º '–ì—É—Ä—É –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞'.*",
            "hook": f'(–ì–æ–ª–æ—Å, —Å –≥–Ω–µ–≤–æ–º): "–í–∞–º —Å–Ω–æ–≤–∞ –ø—Ä–æ–¥–∞–ª–∏ \'—É—Å–ø–µ—à–Ω—ã–π —É—Å–ø–µ—Ö\'? –•–≤–∞—Ç–∏—Ç –∫–æ—Ä–º–∏—Ç—å—Å—è –º—É—Å–æ—Ä–æ–º! {anchor_phrase}".strip()',
            "content": '(–ù–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å–∫–∏–π —Ç–æ–Ω, –Ω–∞ —Ñ–æ–Ω–µ —Å—Ö–µ–º–∞): "–ù–∞—Å—Ç–æ—è—â–∏–π —Ä–æ—Å—Ç - —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞. –í–æ—Ç 3 —à–∞–≥–∞, –∫–∞–∫ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —Ö–∞–æ—Å –≤ –º–µ—Ö–∞–Ω–∏–∑–º..."',
            "cta": cta
        }

    def _call_llm_for_script_generation(self, profile: ClientProfileHub, anchor_points: Dict, product: Optional[Product] = None) -> Optional[Dict[str, str]]:
        if not self.api_key:
            return self._get_mock_script(profile, product)

        print("\nü§ñ [Real AI] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è —á–µ—Ä–µ–∑ Gemini API...")
        
        product_context = ""
        if product:
            product_context = f"""
        - Product to Promote:
          - Name: {product.name}
          - Price: ${product.price}
          - Purpose: {product.purpose}"""

        prompt = f"""
        You are an expert scriptwriter for social media. Your task is to generate a script for a short video based on the provided context.
        The output MUST be a valid JSON object with the following keys: "title", "shock", "hook", "content", "cta".
        Do not add any text or explanations before or after the JSON object.

        **Context:**
        - Client Profile:
          - Brand Name: {profile.brand_name}
          - Superpower: {profile.superpower}
          - Tone of Voice: {profile.style_voice.get('tone_of_voice', '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π')}
          - Enemies: {', '.join(profile.enemies)}
        - 8 Anchor Points:
          - Idea: '{anchor_points.get('idea')}'
          - Content Carrier: {anchor_points.get('content_carrier')}
          - Format: {anchor_points.get('format')}
          - Blog Genre: {anchor_points.get('blog_genre')}
          - Extras/Triggers: {', '.join(anchor_points.get('extras_triggers', []))}
          - Movie Genre: {anchor_points.get('movie_genre')}
          - TV Genre: {anchor_points.get('tv_genre')}
          - Character: {anchor_points.get('character')}{product_context}

        **Task:** Generate a script for a short video.
        **Constraint 1 (Anti-Swipe):** Use: –®–æ–∫ -> –•—É–∫ -> –ö–æ–Ω—Ç–µ–Ω—Ç -> CTA.
        **Constraint 2 (Product-Led):** If a product is mentioned, the CTA must lead to it.
        **Constraint 3 (Verbal Code):** The script MUST include one of these anchor phrases: {profile.style_voice.get('anchor_phrases', [])}. Do not use forbidden words: {profile.style_voice.get('forbidden_words', [])}.
        """
        print("--- –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ü—Ä–æ–º–ø—Ç –¥–ª—è AI (—Å–∏–º—É–ª—è—Ü–∏—è) ---")
        print(prompt)

        try:
            safety_settings = {
                'HARM_CATEGORY_HARASSMENT': 'BLOCK_ONLY_HIGH',
                'HARM_CATEGORY_HATE_SPEECH': 'BLOCK_ONLY_HIGH',
                'HARM_CATEGORY_SEXUALLY_EXPLICIT': 'BLOCK_ONLY_HIGH',
                'HARM_CATEGORY_DANGEROUS_CONTENT': 'BLOCK_ONLY_HIGH',
            }
            model = genai.GenerativeModel('gemini-pro-latest')
            response = model.generate_content(
                prompt,
                safety_settings=safety_settings)
            cleaned_response = response.text.strip().replace("```json", "").replace("```", "")
            return json.loads(cleaned_response)
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ Gemini API: {e}")
            return None

    def process(self, profile: ClientProfileHub, anchor_points: Dict, product: Optional[Product] = None) -> Optional[Dict[str, str]]:
        print("üé¨ –ó–∞–ø—É—Å–∫ AI-–°—Ü–µ–Ω–∞—Ä–Ω–æ–≥–æ –ü—Ä–æ–¥—é—Å–µ—Ä–∞...")
        script = self._call_llm_for_script_generation(profile, anchor_points, product)
        if script:
            print("‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!")
        return script

class InterviewEngine:
    """
    –†–µ–∞–ª–∏–∑—É–µ—Ç "AI-–ò–Ω—Ç–µ—Ä–≤—å—é–µ—Ä–∞" –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
    """
    def __init__(self, api_key: Optional[str] = None):
        self.api_key = api_key
        if api_key:
            genai.configure(api_key=api_key)

    def get_follow_up_question(self, main_question: str, conversation_history: str) -> Optional[str]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        """
        if not self.api_key:
            print("‚ö†Ô∏è API-–∫–ª—é—á –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω. –£—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –Ω–µ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.")
            return "–°–ø–∞—Å–∏–±–æ, –ø—Ä–∏–Ω—è—Ç–æ. –ú–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É."

        print("\nü§ñ [AI-–ò–Ω—Ç–µ—Ä–≤—å—é–µ—Ä] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Ç–æ—á–Ω—è—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞...")

        prompt = f"""
        You are a thoughtful and empathetic strategic consultant conducting an interview. Your goal is to help the user provide a deep and comprehensive answer.
        A main question was asked, and the user has provided some answers.
        Based on the conversation so far, ask ONE clarifying or deepening follow-up question to encourage the user to elaborate.
        - If the answer is short, ask for more details.
        - If the answer mentions something interesting, ask to expand on that specific point.
        - If the answer is very comprehensive, you can simply say "–°–ø–∞—Å–∏–±–æ, —ç—Ç–æ –æ—á–µ–Ω—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç. –ö–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã, –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É."
        - Your question should be polite, encouraging, and in Russian.

        **Main Question:**
        {main_question}

        **Conversation History so far:**
        {conversation_history}

        Now, provide the next follow-up question.
        """
        try:
            model = genai.GenerativeModel('gemini-pro-latest')
            response = model.generate_content(prompt)
            # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            follow_up = response.text.strip().replace("*", "")
            return follow_up
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É—Ç–æ—á–Ω—è—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞: {e}")
            return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."

class CalendarEngine:
    """
    –†–µ–∞–ª–∏–∑—É–µ—Ç "–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ö–∞–ª–µ–Ω–¥–∞—Ä—å" (–ß–∞—Å—Ç—å VII.2) –∏ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—é (–ß–∞—Å—Ç—å VI.1.3).
    –ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (—Å—Ü–µ–Ω–∞—Ä–∏–∏) –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏.
    """
    def _get_sop_template(self, content_carrier: str) -> List[str]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —à–∞–±–ª–æ–Ω —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä (SOP) –¥–ª—è —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.
        """
        print(f"üìö [–ö–∞–ª–µ–Ω–¥–∞—Ä—å] –ü–æ–∏—Å–∫ —à–∞–±–ª–æ–Ω–∞ –∑–∞–¥–∞—á –¥–ª—è '{content_carrier}'...")
        templates = {
            "–®–æ—Ä—Ç—Å": [
                "–ù–∞–ø–∏—Å–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è",
                "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç: [props_list]",
                "–°–Ω—è—Ç—å A-Roll (–≥–æ–≤–æ—Ä—è—â–∞—è –≥–æ–ª–æ–≤–∞)",
                "–°–Ω—è—Ç—å B-Roll (–ø–µ—Ä–µ–±–∏–≤–∫–∏, –¥–µ—Ç–∞–ª–∏)",
                "–°–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é V1",
                "–î–æ–±–∞–≤–∏—Ç—å —Å—É–±—Ç–∏—Ç—Ä—ã –∏ –º—É–∑—ã–∫—É",
                "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º"
            ]
        }
        return templates.get(content_carrier, ["–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –∑–∞–¥–∞—á–∏"])

    def decompose_script_to_tasks(self, generated_script: str, anchor_points: Dict) -> List[Task]:
        """
        –î–µ–∫–æ–º–ø–æ–∑–∏—Ä—É–µ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π –≤ —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á, –∏—Å–ø–æ–ª—å–∑—É—è "–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –û–±–æ–≥–∞—â–µ–Ω–∏–µ".
        """
        print("üóìÔ∏è  –ó–∞–ø—É—Å–∫ –î–≤–∏–∂–∫–∞ –ö–∞–ª–µ–Ω–¥–∞—Ä—è: –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è –≤ –∑–∞–¥–∞—á–∏...")
        content_carrier = anchor_points.get("content_carrier", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
        template_steps = self._get_sop_template(content_carrier)

        # --- –£–ª—É—á—à–µ–Ω–∏–µ: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞ ---
        # –ò–º–∏—Ç–∏—Ä—É–µ–º, —á—Ç–æ AI "–ø—Ä–æ—á–∏—Ç–∞–ª" —Å—Ü–µ–Ω–∞—Ä–∏–π –∏ –Ω–∞—à–µ–ª —Ä–µ–∫–≤–∏–∑–∏—Ç
        props_list = "–Ω–µ –Ω–∞–π–¥–µ–Ω"
        if "–¥–∏–ø–ª–æ–º" in generated_script:
            props_list = "–¥–∏–ø–ª–æ–º '–ì—É—Ä—É –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞', –±—É–º–∞–≥–∞ –¥–ª—è —Ä–≤–∞–Ω–∏—è"
        print(f"üïµÔ∏è  [–ö–∞–ª–µ–Ω–¥–∞—Ä—å] –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ä–µ–∫–≤–∏–∑–∏—Ç: '{props_list}'")

        tasks = []
        for step in template_steps:
            # –ü—Ä–∏–º–µ—Ä "–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –û–±–æ–≥–∞—â–µ–Ω–∏—è"
            enriched_step = step.replace("[props_list]", props_list)
            tasks.append(Task(description=enriched_step))
        
        print(f"‚úÖ –°–æ–∑–¥–∞–Ω–æ {len(tasks)} –∑–∞–¥–∞—á –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞.")
        return tasks
print("üöÄ –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω!")
import json
from dataclasses import asdict
from core_logic import (
    IngestionEngine, 
    BlueOceanEngine, 
    HarmonyDiagnosticEngine, 
    CommerceEngine, 
    AIScenarioProducer, 
    CalendarEngine
)

# ==============================================================================
# --- –ì–õ–ê–í–ù–´–ô –ö–û–ù–í–ï–ô–ï–† (–¢–û–ß–ö–ê –í–•–û–î–ê) ---
# ==============================================================================
if __name__ == "__main__":
    
    # --- –®–ê–ì 1-3: –°–¢–†–ê–¢–ï–ì–ò–ß–ï–°–ö–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê ---
    ingestion_engine = IngestionEngine()
    client_profile = ingestion_engine.process("""
    –¢–µ–∫—Å—Ç –∏–∑ –ú–∞—Å—Ç–µ—Ä-–û–ø—Ä–æ—Å–Ω–∏–∫–∞... –ú–æ—è –º–∞–Ω–µ—Ä–∞ –æ–±—â–µ–Ω–∏—è - –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω–∞—è, –Ω–æ —Å –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞. 
    –Ø —á–∞—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä—è—é —Ñ—Ä–∞–∑—ã "–†–∞–±–æ—Ç–∞–µ–º", "–≠—Ç–æ –±–∞–∑–∞". 
    –ù–µ–Ω–∞–≤–∏–∂—É, –∫–æ–≥–¥–∞ –≥–æ–≤–æ—Ä—è—Ç "–∫–æ—Ä–æ—á–µ".
    """)
    
    blue_ocean_engine = BlueOceanEngine()
    client_profile.positioning_matrix = blue_ocean_engine.process("–¢–µ–∫—Å—Ç –ø—Ä–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤...")
    
    harmony_engine = HarmonyDiagnosticEngine()
    client_profile = harmony_engine.process(client_profile)
    
    # --- –®–ê–ì 4: –ü–†–û–ï–ö–¢–ò–†–û–í–ê–ù–ò–ï –ü–†–û–î–£–ö–¢–û–í–û–ô –õ–ò–ù–ï–ô–ö–ò ---
    commerce_engine = CommerceEngine()
    product_ladder = commerce_engine.process(client_profile)
    client_profile.products = [asdict(p) for p in [product_ladder.lead_magnet, product_ladder.tripwire, product_ladder.core_offer, product_ladder.high_ticket] if p]
    
    print("\n" + "="*60)
    print("--- –ò—Ç–æ–≥–æ–≤—ã–π Client_Profile_Hub (—Å –ü—Ä–æ–¥—É–∫—Ç–∞–º–∏) ---")
    print(json.dumps(asdict(client_profile), indent=2, ensure_ascii=False, default=str))
    
    # --- –®–ê–ì 5: –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–û–ù–¢–ï–ù–¢–ê, –ü–†–û–î–í–ò–ì–ê–Æ–©–ï–ì–û –ü–†–û–î–£–ö–¢ (Product-Led Content) ---
    print("\n" + "="*60)
    print("--- –¢–ê–ö–¢–ò–ß–ï–°–ö–ò–ô –†–ï–ñ–ò–ú: –ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–†–û–î–ê–Æ–©–ï–ì–û –ö–û–ù–¢–ï–ù–¢–ê ---")
    print("="*60)
    
    scenario_producer = AIScenarioProducer()
    
    # –í—ã–±–∏—Ä–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¢—Ä–∏–ø–≤–∞–π–µ—Ä)
    product_to_promote = product_ladder.tripwire
    
    if product_to_promote:
        selected_points = {
            "idea": f"–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ '{product_to_promote.name}' —á–µ—Ä–µ–∑ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞",
            "content_carrier": "–®–æ—Ä—Ç—Å",
        }
        generated_script = scenario_producer.process(client_profile, selected_points, product_to_promote)
        
        print("\n--- –ì–û–¢–û–í–´–ô –°–¶–ï–ù–ê–†–ò–ô (Product-Led) ---")
        print(generated_script)
    else:
        print("‚ö†Ô∏è –ü—Ä–æ–¥—É–∫—Ç –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω.")

    # --- –®–ê–ì 6: –î–ï–ö–û–ú–ü–û–ó–ò–¶–ò–Ø –í –ó–ê–î–ê–ß–ò (–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ –Ø–¥—Ä–æ) ---
    print("\n" + "="*60)
    print("--- –û–ü–ï–†–ê–¶–ò–û–ù–ù–û–ï –Ø–î–†–û: –î–ï–ö–û–ú–ü–û–ó–ò–¶–ò–Ø –í –ó–ê–î–ê–ß–ò ---")
    print("="*60)

    calendar_engine = CalendarEngine()
    project_tasks = calendar_engine.decompose_script_to_tasks(generated_script, selected_points)

    print("\n--- –ü–õ–ê–ù –ü–†–û–ï–ö–¢–ê (–°–ü–ò–°–û–ö –ó–ê–î–ê–ß) ---")
    for i, task in enumerate(project_tasks, 1):
        print(f"{i}. {task.description} (–°—Ç–∞—Ç—É—Å: {task.status})")

streamlit
google-generativeai
pandas
